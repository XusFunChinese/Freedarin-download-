<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, landscape=yes">
    <title>HSK 1 Master - XUSFUNCHINESE</title>
    <style>
        :root {
            --primary: #01579b; 
            --accent: #e1f5fe;  
            --gold: #fbc02d;
            --pinyin: #d0021b; 
            --night-sky: radial-gradient(circle at center, #001f3f 0%, #000510 100%);
        }
        
        body { 
            margin: 0; font-family: "Arial Black", "Segoe UI", Tahoma, sans-serif; 
            background: linear-gradient(135deg, #0277bd 0%, #002f6c 100%); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: 5000; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: opacity 0.8s ease-out, visibility 0.8s; overflow: hidden;
        }

        .star {
            position: absolute; top: 50%; left: 50%; width: 2px; height: 2px;
            background: white; border-radius: 50%; box-shadow: 0 0 10px #fff;
            animation: shoot linear infinite;
        }

        @keyframes shoot {
            0% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(1000px); opacity: 0; width: 160px; }
        }

        .cover-content { text-align: center; z-index: 10; padding: 20px; }
        .cover-title { font-size: 7.5vw; color: white; line-height: 1.2; text-transform: uppercase; margin: 0; }
        .cover-subtitle { font-size: 10vw; color: var(--gold); margin-top: 5px; font-weight: 900; animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .click-hint { margin-top: 20px; color: white; font-size: 20px; opacity: 0.8; letter-spacing: 2px; }

        header { 
            background: rgba(255,255,255,0.95); padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; 
        }
        .header-left { display: flex; align-items: center; }
        .nav-btns button { 
            padding: 8px 12px; margin-right: 5px; border-radius: 20px; border: 2px solid var(--primary); 
            cursor: pointer; font-weight: bold; background: white; color: var(--primary);
        }
        .active-mode { background: var(--primary) !important; color: white !important; }
        .inline-watermark { margin-left: 15px; font-weight: 900; font-size: 18px; color: var(--primary); opacity: 0.5; border-left: 2px solid #ddd; padding-left: 15px; }

        main { flex: 1; display: flex; padding: 20px; gap: 15px; overflow: hidden; }
        #left-panel { flex: 1; background: rgba(255,255,255,0.95); border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid var(--accent); position: relative; }
        #right-panel { flex: 1.6; background: rgba(255,255,255,0.95); border-radius: 30px; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; border: 4px solid var(--accent); position: relative; }

        ruby { ruby-align: center; font-size: 40px; margin: 0 4px; line-height: 2.2; font-weight: 600; }
        rt { font-size: 18px; color: var(--pinyin); font-weight: bold; }
        .eng-hint { display: block; font-size: 24px; color: #333; margin-top: 15px; border-top: 2px dashed #ccc; padding-top: 10px; font-style: italic; }
        #emoji-display { font-size: 120px; margin-bottom: 20px; }
        
        .option-btn { background: white; border: 2px solid var(--primary); padding: 15px; margin: 8px 0; border-radius: 15px; cursor: pointer; font-size: 20px; width: 100%; transition: 0.2s; }
        
        #scroll-view { display: none; width: 100%; overflow-y: auto; padding: 30px; background: white; border-radius: 30px; }
        .list-row { border-bottom: 1px solid var(--accent); padding: 15px; cursor: pointer; }
        .hidden { display: none !important; }
        #timer-display { font-size: 24px; color: #d32f2f; font-weight: bold; margin-right: 15px; }

        #result-screen { text-align: center; padding: 30px; width: 100%; }
        .result-score { font-size: 100px; color: var(--gold); margin: 10px 0; text-shadow: 2px 4px 10px rgba(0,0,0,0.1); }
        .subscribe-msg { font-size: 22px; color: var(--primary); font-weight: 900; margin-bottom: 40px; line-height: 1.4; }
    </style>
</head>
<body>

<div id="cover-page" onclick="enterApp()">
    <div id="star-container"></div>
    <div class="cover-content">
        <h1 class="cover-title">50 MINI<br>DIALOGUES (1)</h1>
        <div class="cover-subtitle">HSK 1</div>
        <div class="click-hint">CLICK TO START</div>
    </div>
</div>

<header>
    <div class="header-left">
        <div class="nav-btns">
            <button onclick="setMode('study')" id="btn-study">ğŸ“– Study</button>
            <button onclick="setMode('review')" id="btn-review">ğŸ”„ Review</button>
            <button onclick="setMode('practice')" id="btn-practice">âœï¸ Practice</button>
            <button onclick="setMode('quiz')" id="btn-quiz">âš¡ Rush (30s)</button>
            <button onclick="setMode('list')" id="btn-list">ğŸ“œ Bank</button>
            <button onclick="setMode('wrong')" id="btn-wrong" style="border-color: #f44336; color: #f44336;">âŒ Mistake</button>
        </div>
        <div class="inline-watermark">XUSFUNCHINESE</div>
    </div>
    <div id="status-bar" style="display: flex; align-items: center;">
        <span id="timer-display" class="hidden">00:30</span>
        <span style="font-weight: bold; color: var(--primary);">Score: <span id="score-val">0</span></span>
    </div>
</header>

<main>
    <div id="main-ui" style="display: flex; width: 100%; gap: 15px;">
        <div id="left-panel">
            <div id="emoji-display">ğŸ‘‹</div>
            <button onclick="speakItem(true)" style="padding: 15px 40px; border-radius: 50px; cursor: pointer; background: var(--primary); color: white; border: none; font-weight: bold; font-size: 20px;">ğŸ”Š Audio</button>
        </div>
        <div id="right-panel">
            <div id="display-area"></div>
            <div id="hint-box" style="margin-top:20px; padding:15px; background:#fffde7; border-left:8px solid var(--gold); border-radius:12px;" class="hidden"></div>
            <div id="interaction-area" style="margin-top: 15px;"></div>
        </div>
    </div>
    <div id="scroll-view"></div>
</main>

<script>
    const database = [
        ["ä½ å¥½ï¼", "nÇ hÇo !", "Hello!", "ğŸ˜Š", {cn: "ä½ å¥½ï¼", py: "nÇ hÇo !", en: "Hello!"}],
        ["ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ", "nÇ jiÃ o shÃ©n me mÃ­ng zi ?", "What's your name?", "ğŸ“", {cn: "æˆ‘å«å¤§å«ã€‚", py: "wÇ’ jiÃ o dÃ  wÃ¨i .", en: "My name is David."}],
        ["ä½ æ˜¯è€å¸ˆå—ï¼Ÿ", "nÇ shÃ¬ lÇo shÄ« ma ?", "Are you a teacher?", "ğŸ‘¨â€ğŸ«", {cn: "ä¸æ˜¯ï¼Œæˆ‘æ˜¯å­¦ç”Ÿã€‚", py: "bÃº shÃ¬ , wÇ’ shÃ¬ xuÃ© sheng .", en: "No, I am a student."}],
        ["ä½ æ˜¯å“ªå›½äººï¼Ÿ", "nÇ shÃ¬ nÇ guÃ³ rÃ©n ?", "Which country are you from?", "ğŸŒ", {cn: "æˆ‘æ˜¯ç¾å›½äººã€‚", py: "wÇ’ shÃ¬ mÄ›i guÃ³ rÃ©n .", en: "I am American."}],
        ["è°¢è°¢ä½ ï¼", "xiÃ¨ xie nÇ !", "Thank you!", "ğŸ™", {cn: "ä¸å®¢æ°”ã€‚", py: "bÃº kÃ¨ qi .", en: "You're welcome."}],
        ["å†è§ï¼", "zÃ i jiÃ n !", "Goodbye!", "ğŸ‘‹", {cn: "å†è§ï¼", py: "zÃ i jiÃ n !", en: "Goodbye!"}],
        ["ä½ ä¼šè¯´æ±‰è¯­å—ï¼Ÿ", "nÇ huÃ¬ shuÅ hÃ n yÇ” ma ?", "Can you speak Chinese?", "ğŸ—£ï¸", {cn: "æˆ‘ä¼šè¯´ä¸€ç‚¹å„¿ã€‚", py: "wÇ’ huÃ¬ shuÅ yÃ¬ diÇnr .", en: "I can speak a little bit."}],
        ["ä½ çš„è€å¸ˆæ˜¯è°ï¼Ÿ", "nÇ de lÇo shÄ« shÃ¬ shÃ©i ?", "Who is your teacher?", "ğŸ‘©â€ğŸ«", {cn: "å¥¹æ˜¯æè€å¸ˆã€‚", py: "tÄ shÃ¬ lÇ lÇo shÄ« .", en: "She is Teacher Li."}],
        ["ä»Šå¤©å‡ å·ï¼Ÿ", "jÄ«n tiÄn jÇ hÃ o ?", "What's the date today?", "ğŸ“…", {cn: "ä»Šå¤©ä¸€æœˆä¸€å·ã€‚", py: "jÄ«n tiÄn yÄ« yuÃ¨ yÄ« hÃ o .", en: "Today is Jan 1st."}],
        ["ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ", "jÄ«n tiÄn xÄ«ng qÄ« jÇ ?", "What day is it today?", "ğŸ—“ï¸", {cn: "ä»Šå¤©æ˜ŸæœŸä¸‰ã€‚", py: "jÄ«n tiÄn xÄ«ng qÄ« sÄn .", en: "Today is Wednesday."}],
        ["ä½ æƒ³å–ä»€ä¹ˆï¼Ÿ", "nÇ xiÇng hÄ“ shÃ©n me ?", "What to drink?", "â˜•", {cn: "æˆ‘æƒ³å–èŒ¶ã€‚", py: "wÇ’ xiÇng hÄ“ chÃ¡ .", en: "I want to drink tea."}],
        ["ä½ æƒ³åƒä»€ä¹ˆï¼Ÿ", "nÇ xiÇng chÄ« shÃ©n me ?", "What to eat?", "ğŸš", {cn: "æˆ‘æƒ³åƒç±³é¥­ã€‚", py: "wÇ’ xiÇng chÄ« mÇ fÃ n .", en: "I want to eat rice."}],
        ["è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ", "zhÃ¨ ge duÅ shao qiÃ¡n ?", "How much is this?", "ğŸ’°", {cn: "ä¸‰åå—ã€‚", py: "sÄn shÃ­ kuÃ i .", en: "Thirty RMB."}],
        ["ä½ ä¼šå†™æ±‰å­—å—ï¼Ÿ", "nÇ huÃ¬ xiÄ› hÃ n zÃ¬ ma ?", "Can you write Chinese?", "âœï¸", {cn: "æˆ‘ä¼šå†™ä¸€äº›ã€‚", py: "wÇ’ huÃ¬ xiÄ› yÃ¬ xiÄ“ .", en: "I can write some."}],
        ["ç°åœ¨å‡ ç‚¹ï¼Ÿ", "xiÃ n zÃ i jÇ diÇn ?", "What time is it?", "âŒš", {cn: "åç‚¹ååˆ†ã€‚", py: "shÃ­ diÇn shÃ­ fÄ“n .", en: "Ten past ten."}],
        ["ä½ å®¶æœ‰å‡ å£äººï¼Ÿ", "nÇ jiÄ yÇ’u jÇ kÇ’u rÃ©n ?", "How many in family?", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", {cn: "ä¸‰å£äººã€‚", py: "sÄn kÇ’u rÃ©n .", en: "Three people."}],
        ["ä½ å¥³å„¿å¤šå¤§äº†ï¼Ÿ", "nÇ nÇš Ã©r duÅ dÃ  le ?", "How old is daughter?", "ğŸ‘§", {cn: "å¥¹äº”å²äº†ã€‚", py: "tÄ wÇ” suÃ¬ le .", en: "She is five."}],
        ["ä½ ä¼šåšä¸­å›½èœå—ï¼Ÿ", "nÇ huÃ¬ zuÃ² zhÅng guÃ³ cÃ i ma ?", "Can you cook Chinese food?", "ğŸ³", {cn: "æˆ‘ä¼šåšã€‚", py: "wÇ’ huÃ¬ zuÃ² .", en: "I can."}],
        ["ä»–åœ¨å“ªå„¿ï¼Ÿ", "tÄ zÃ i nÇ r ?", "Where is he?", "ğŸ“", {cn: "ä»–åœ¨å­¦æ ¡ã€‚", py: "tÄ zÃ i xuÃ© xiÃ o .", en: "He is at school."}],
        ["ä¹¦åº—åœ¨å“ªå„¿ï¼Ÿ", "shÅ« diÃ n zÃ i nÇ r ?", "Where is bookstore?", "ğŸ“š", {cn: "åœ¨åŒ»é™¢å‰é¢ã€‚", py: "zÃ i yÄ« yuÃ n qiÃ¡n mian .", en: "In front of hospital."}],
        ["ä»–åœ¨åšä»€ä¹ˆï¼Ÿ", "tÄ zÃ i zuÃ² shÃ©n me ?", "What is he doing?", "ğŸ“±", {cn: "ä»–åœ¨çœ‹ç”µå½±ã€‚", py: "tÄ zÃ i kÃ n diÃ n yÇng .", en: "Watching a movie."}],
        ["æ˜¨å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ", "zuÃ³ tiÄn tiÄn qÃ¬ zÄ›n me yÃ ng ?", "How was the weather yesterday?", "â˜€ï¸", {cn: "å¾ˆå¥½ã€‚", py: "hÄ›n hÇo .", en: "Very good."}],
        ["æ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ", "mÃ­ng tiÄn huÃ¬ xiÃ  yÇ” ma ?", "Will it rain tomorrow?", "â˜”", {cn: "ä¸ä¼šä¸‹é›¨ã€‚", py: "bÃº huÃ¬ xiÃ  yÇ” .", en: "It won't rain."}],
        ["ä½ èº«ä½“æ€ä¹ˆæ ·ï¼Ÿ", "shÄ“n tÇ zÄ›n me yÃ ng ?", "How's your health?", "ğŸ’ª", {cn: "æˆ‘èº«ä½“å¾ˆå¥½ã€‚", py: "wÇ’ shÄ“n tÇ hÄ›n hÇo .", en: "I'm very well."}],
        ["ä½ ä¹°ä»€ä¹ˆäº†ï¼Ÿ", "nÇ mÇi shÃ©n me le ?", "What did you buy?", "ğŸ›ï¸", {cn: "ä¸€äº›è‹¹æœã€‚", py: "yÃ¬ xiÄ“ pÃ­ng guÇ’ .", en: "Some apples."}],
        ["ä½ æ€ä¹ˆå»å­¦æ ¡ï¼Ÿ", "nÇ zÄ›n me qÃ¹ xuÃ© xiÃ o ?", "How to go to school?", "ğŸš²", {cn: "åå‡ºç§Ÿè½¦ã€‚", py: "zuÃ² chÅ« zÅ« chÄ“ .", en: "By taxi."}],
        ["è¡£æœæ¼‚äº®å—ï¼Ÿ", "yÄ« fu piÃ o liang ma ?", "Are clothes pretty?", "ğŸ‘—", {cn: "å¾ˆæ¼‚äº®ã€‚", py: "hÄ›n piÃ o liang .", en: "Very pretty."}],
        ["ä»€ä¹ˆæ—¶å€™å›å®¶ï¼Ÿ", "shÃ­ hou huÃ­ jiÄ ?", "When go home?", "ğŸ ", {cn: "ä¸‹åˆäº”ç‚¹ã€‚", py: "xiÃ  wÇ” wÇ” diÇn .", en: "At 5 PM."}],
        ["ä½ è®¤è¯†ä»–å—ï¼Ÿ", "nÇ rÃ¨n shi tÄ ma ?", "Know him?", "ğŸ‘¤", {cn: "ä¸è®¤è¯†ã€‚", py: "bÃº rÃ¨n shi .", en: "Don't know him."}],
        ["è¯·åï¼Œå–ç‚¹æ°´ã€‚", "qÇng zuÃ² , hÄ“ diÇn shuÇ .", "Sit & drink water.", "ğŸ¥¤", {cn: "è°¢è°¢ã€‚", py: "xiÃ¨ xie .", en: "Thank you."}],
        ["é‚£æ˜¯è°çš„æ¯å­ï¼Ÿ", "nÃ  shÃ¬ shÃ©i de bÄ“i zi ?", "Whose cup is that?", "ğŸ¥›", {cn: "æˆ‘çˆ¸çˆ¸çš„ã€‚", py: "wÇ’ bÃ  ba de .", en: "My father's."}],
        ["ä»–åœ¨å“ªå„¿å·¥ä½œï¼Ÿ", "tÄ zÃ i nÇ r gÅng zuÃ² ?", "Where does he work?", "ğŸ¥", {cn: "ä»–åœ¨åŒ»é™¢ã€‚", py: "tÄ zÃ i yÄ« yuÃ n .", en: "At a hospital."}],
        ["æ¡Œå­ä¸Šæœ‰ä»€ä¹ˆï¼Ÿ", "zhuÅ zi shang yÇ’u shÃ©n me ?", "What's on table?", "ğŸ–¥ï¸", {cn: "æœ‰ä¸€å°ç”µè„‘ã€‚", py: "yÇ’u yÃ¬ tÃ¡i diÃ n nÇo .", en: "A computer."}],
        ["ä½ å–œæ¬¢çœ‹ä¹¦å—ï¼Ÿ", "nÇ xÇ huan kÃ n shÅ« ma ?", "Like reading?", "ğŸ“–", {cn: "æˆ‘å¾ˆå–œæ¬¢ã€‚", py: "wÇ’ hÄ›n xÇ huan .", en: "I like it a lot."}],
        ["è¿™é‡Œæœ‰äººå—ï¼Ÿ", "zhÃ¨ lÇ yÇ’u rÃ©n ma ?", "Anyone here?", "ğŸª‘", {cn: "æ²¡æœ‰äººã€‚", py: "mÃ©i yÇ’u rÃ©n .", en: "No one."}],
        ["ä½ æ˜¯å“ªå¹´å‡ºç”Ÿçš„ï¼Ÿ", "nÇ shÃ¬ nÇ niÃ¡n chÅ« shÄ“ng de ?", "Born year?", "ğŸ¼", {cn: "ä¸€ä¹ä¹äº”å¹´ã€‚", py: "yÄ« jiÇ” jiÇ” wÇ” niÃ¡n .", en: "In 1995."}],
        ["å¤–é¢å†·å—ï¼Ÿ", "wÃ i mian lÄ›ng ma ?", "Cold outside?", "â„ï¸", {cn: "ä¸å†·ï¼Œå¾ˆçƒ­ã€‚", py: "bÃ¹ lÄ›ng , hÄ›n rÃ¨ .", en: "Not cold, hot."}],
        ["ä½ ä¸ºä»€ä¹ˆä¸åƒï¼Ÿ", "nÇ wÃ¨i shÃ©n me bÃ¹ chÄ« ?", "Why not eat?", "ğŸ™…â€â™‚ï¸", {cn: "æˆ‘ä¸é¥¿ã€‚", py: "wÇ’ bÃº Ã¨ .", en: "I'm not hungry."}],
        ["ä½ ä¼šå¼€è½¦å—ï¼Ÿ", "nÇ huÃ¬ kÄi chÄ“ ma ?", "Can you drive?", "ğŸš—", {cn: "æˆ‘ä¼šå¼€ã€‚", py: "wÇ’ huÃ¬ kÄi .", en: "I can drive."}],
        ["è½¦ç«™æ€ä¹ˆèµ°ï¼Ÿ", "chÄ“ zhÃ n zÄ›n me zÇ’u ?", "How to get to station?", "ğŸš‰", {cn: "ä¸€ç›´èµ°ã€‚", py: "yÃ¬ zhÃ­ zÇ’u .", en: "Go straight."}],
        ["å­¦æ±‰è¯­å¤šä¹…äº†ï¼Ÿ", "xuÃ© hÃ n yÇ” duÅ jiÇ” le ?", "Learned how long?", "â³", {cn: "ä¸€å¹´äº†ã€‚", py: "yÃ¬ niÃ¡n le .", en: "One year."}],
        ["ç”µå½±å‡ ç‚¹å¼€å§‹ï¼Ÿ", "diÃ n yÇng jÇ diÇn kÄi shÇ ?", "Movie start time?", "ğŸ¿", {cn: "æ™šä¸Šä¸ƒç‚¹ã€‚", py: "wÇn shang qÄ« diÇn .", en: "7 PM."}],
        ["ä¹°å‡ æœ¬ä¹¦ï¼Ÿ", "mÇi jÇ bÄ›n shÅ« ?", "Buy how many books?", "ğŸ”–", {cn: "ä¹°ä¸‰æœ¬ã€‚", py: "mÇi sÄn bÄ›n .", en: "Buy three."}],
        ["æ±‰è¯­è¯´å¾—æ€ä¹ˆæ ·ï¼Ÿ", "hÃ n yÇ” shuÅ de zÄ›n me yÃ ng ?", "How's your Chinese?", "ğŸ‘", {cn: "ä¸å¤ªå¥½ã€‚", py: "bÃº tÃ i hÇo .", en: "Not very good."}],
        ["ç‹å…ˆç”Ÿåœ¨å—ï¼Ÿ", "wÃ¡ng xiÄn sheng zÃ i ma ?", "Is Mr. Wang here?", "ğŸšª", {cn: "ä»–ä¸åœ¨ã€‚", py: "tÄ bÃº zÃ i .", en: "He is out."}],
        ["è®¤è¯†è·¯å—ï¼Ÿ", "rÃ¨n shi lÃ¹ ma ?", "Know the way?", "ğŸ—ºï¸", {cn: "è®¤è¯†ï¼Œè·Ÿæˆ‘èµ°ã€‚", py: "rÃ¨n shi , gÄ“n wÇ’ zÇ’u .", en: "Yes, follow me."}],
        ["ä¸€å…±å¤šå°‘é’±ï¼Ÿ", "yÃ­ gÃ²ng duÅ shao qiÃ¡n ?", "Total cost?", "ğŸ’´", {cn: "äº”åå—ã€‚", py: "wÇ” shÃ­ kuÃ i .", en: "50 RMB."}],
        ["å¯ä»¥æ‰“ç”µè¯å—ï¼Ÿ", "kÄ› yÇ dÇ diÃ n huÃ  ma ?", "Can I call?", "ğŸ“", {cn: "å¯ä»¥ã€‚", py: "kÄ› yÇ .", en: "Yes."}],
        ["é‚£æ˜¯ä½ çš„çŒ«å—ï¼Ÿ", "nÃ  shÃ¬ nÇ de mÄo ma ?", "Is that your cat?", "ğŸ±", {cn: "ä¸æ˜¯ï¼Œæˆ‘å§å§çš„ã€‚", py: "bÃº shÃ¬ , wÇ’ jiÄ› jie de .", en: "No, my sister's."}],
        ["æˆ‘ä»¬èµ°å§ï¼", "wÇ’ men zÇ’u ba !", "Let's go!", "ğŸƒ", {cn: "èµ°å§ã€‚", py: "zÇ’u ba .", en: "Let's go."}]
    ];

    let currentMode = 'study', currentIndex = 0, score = 0, timer = null;
    let wrongAnswers = [];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playEffect(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if(type === 'coin') {
            osc.frequency.setValueAtTime(987, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1318, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(220, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(110, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        }
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    }

    function initStars() {
        const container = document.getElementById('star-container');
        for(let i=0; i<80; i++) {
            let s = document.createElement('div'); s.className = 'star';
            s.style.setProperty('--angle', Math.random() * 360 + 'deg');
            s.style.animationDuration = Math.random() * 1.5 + 0.8 + 's';
            container.appendChild(s);
        }
    }

    function enterApp() {
        document.getElementById('cover-page').style.opacity = '0';
        setTimeout(() => { document.getElementById('cover-page').style.visibility = 'hidden'; }, 800);
        setMode('study');
    }

    function speakText(text, callback = null) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(text);
        m.lang = 'zh-CN'; m.rate = 0.85;
        if (callback) m.onend = callback;
        window.speechSynthesis.speak(m);
    }

    function speakItem(fullMode = false) {
        const item = database[currentIndex];
        if (fullMode) speakText(item[0], () => setTimeout(() => speakText(item[4].cn), 400));
        else speakText(item[0]);
    }

    function setMode(m) {
        currentMode = m; currentIndex = 0; clearInterval(timer); score = 0;
        document.getElementById('score-val').innerText = "0";
        document.querySelectorAll('.nav-btns button').forEach(b => b.classList.remove('active-mode'));
        if(document.getElementById('btn-'+m)) document.getElementById('btn-'+m).classList.add('active-mode');
        document.getElementById('timer-display').classList.add('hidden');
        
        document.getElementById('right-panel').innerHTML = `<div id="display-area"></div><div id="hint-box" class="hidden"></div><div id="interaction-area"></div>`;

        if(m === 'list' || m === 'wrong') {
            document.getElementById('main-ui').classList.add('hidden');
            document.getElementById('scroll-view').style.display = 'block';
            if (m === 'list') renderList();
            else renderWrongBook();
        } else {
            document.getElementById('main-ui').classList.remove('hidden');
            document.getElementById('scroll-view').style.display = 'none';
            if (m === 'quiz') startRush();
            render();
        }
    }

    function startRush() {
        let timeLeft = 30;
        const display = document.getElementById('timer-display');
        display.classList.remove('hidden');
        timer = setInterval(() => {
            timeLeft--;
            display.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
            if (timeLeft <= 0) { clearInterval(timer); showFinalResult(); }
        }, 1000);
    }

    function showFinalResult() {
        const praises = ["å¤ªæ£’äº†ï¼", "å¹²å¾—æ¼‚äº®ï¼", "ä½ çœŸäº†ä¸èµ·ï¼"];
        speakText(praises[Math.floor(Math.random()*praises.length)]);
        document.getElementById('right-panel').innerHTML = `
            <div id="result-screen">
                <div class="result-score">${score}</div>
                <div class="subscribe-msg">Please subscribe to "Xu's Fun Chinese" on Youtube to learn more!</div>
                <button class="option-btn" onclick="setMode('study')" style="background:var(--primary); color:white; width:220px; margin: 0 auto;">Back to Study</button>
            </div>
        `;
    }

    function generateRubyHtml(text, pinyinStr) {
        const chars = text.split(''); const pys = pinyinStr.split(' ');
        let html = ""; let pyIdx = 0;
        chars.forEach(c => {
            if(/[\u4e00-\u9fa5]/.test(c)) {
                html += `<ruby>${c}<rt>${pys[pyIdx] || ''}</rt></ruby>`; pyIdx++;
            } else if (![' ', '!', '?', 'ï¼', 'ï¼Ÿ', '.', 'ã€‚', ','].includes(c)) {
                html += c; pyIdx++;
            } else html += c;
        });
        return html;
    }

    function render() {
        const item = database[currentIndex];
        const display = document.getElementById('display-area');
        const interaction = document.getElementById('interaction-area');
        const hint = document.getElementById('hint-box');
        
        document.getElementById('emoji-display').innerText = item[3];
        interaction.innerHTML = ""; 
        hint.className = 'hidden';
        hint.style = "margin-top:20px; padding:15px; background:#fffde7; border-left:8px solid var(--gold); border-radius:12px;";

        display.innerHTML = generateRubyHtml(item[0], item[1]) + `<span class="eng-hint">${item[2]}</span>`;

        if(currentMode === 'study' || currentMode === 'review') {
            hint.innerHTML = `<div style="font-size:26px; cursor:pointer;" onclick="speakText('${item[4].cn}')">${generateRubyHtml(item[4].cn, item[4].py)}</div><div style="font-style:italic; color:#666; margin-top:8px;">${item[4].en}</div>`;
            if(currentMode === 'study') {
                hint.classList.remove('hidden');
                speakItem(false); 
            } else {
                interaction.innerHTML = `<button class="option-btn" onclick="document.getElementById('hint-box').classList.toggle('hidden')">ğŸ‘ï¸ Show/Hide Reply</button>`;
                speakItem(false);
            }
            interaction.innerHTML += `<button class="option-btn" onclick="nextCard()" style="background:var(--primary); color:white;">Next â†’</button>`;
        } else {
            let opts = [item[4].cn, "æˆ‘ä¸è®¤è¯†ã€‚", "ä»–åœ¨å®¶é‡Œã€‚", "å¯¹ä¸èµ·ã€‚", "å†è§ã€‚"].slice(0, 4);
            if(!opts.includes(item[4].cn)) opts[0] = item[4].cn;
            opts.sort(() => Math.random() - 0.5);
            opts.forEach(o => {
                const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = o;
                b.onclick = () => {
                    if(o === item[4].cn) {
                        playEffect('coin'); score += 10; document.getElementById('score-val').innerText = score;
                        b.style.background = "#4caf50"; b.style.color = "white";
                        
                        if(currentMode === 'practice') {
                            speakText(item[4].cn, () => setTimeout(nextCard, 300));
                        } else {
                            speakText(item[4].cn);
                            nextCard();
                        }
                    } else { 
                        playEffect('fail'); 
                        b.style.background = "#f44336"; b.style.color = "white"; 
                        // è®°å½•é”™é¢˜
                        if (!wrongAnswers.includes(item)) {
                            wrongAnswers.push(item);
                        }
                    }
                };
                interaction.appendChild(b);
            });
            speakItem(false);
        }
    }

    function nextCard() {
        currentIndex++;
        if (currentIndex >= database.length) {
            if (currentMode === 'quiz' || currentMode === 'practice') showFinalResult();
            else { currentIndex = 0; render(); }
        } else render();
    }

    function renderList() {
        const view = document.getElementById('scroll-view');
        view.innerHTML = "<h2>ğŸ“œ HSK 1 Sentence Bank</h2>";
        database.forEach((it, idx) => {
            const r = document.createElement('div'); r.className = 'list-row';
            r.innerHTML = `<strong>${idx+1}.</strong> <span style="font-size:24px;">${it[0]}</span><br><span style="color:var(--pinyin); font-weight:bold;">${it[1]}</span><br><span style="color:#666">${it[2]}</span>`;
            r.onclick = () => speakText(it[0]);
            view.appendChild(r);
        });
    }

    function renderWrongBook() {
        const view = document.getElementById('scroll-view');
        view.innerHTML = "<h2>âŒ My Mistakes</h2>";
        if (wrongAnswers.length === 0) {
            view.innerHTML += "<p style='font-size:20px; color:#666;'>No mistakes recorded yet. Keep practicing!</p>";
            return;
        }
        wrongAnswers.forEach((it, idx) => {
            const r = document.createElement('div'); r.className = 'list-row';
            r.innerHTML = `<strong>${idx+1}.</strong> <span style="font-size:24px;">${it[0]}</span><br><span style="color:var(--pinyin); font-weight:bold;">${it[1]}</span><br><span style="color:#666">${it[2]}</span><div style="margin-top:8px; color:var(--primary); font-weight:bold;">Reply: ${it[4].cn}</div>`;
            r.onclick = () => speakText(it[0]);
            view.appendChild(r);
        });
    }

    window.onload = () => initStars();
</script>
</body>
</html>