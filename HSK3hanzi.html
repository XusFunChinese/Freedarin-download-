<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>XUSFUNCHINESE - HSK3 Writing Mode üèÆ</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        :root { 
            --pinyin-red: #ff0000;
            --paper: rgba(255, 255, 255, 0.95); 
            --gold: #fbc02d; 
            --accent: #218c74; 
            --primary: #01579b;
            --night-sky: radial-gradient(circle at center, #1a237e 0%, #000510 100%);
        }
        body { 
            margin: 0; font-family: "Arial Black", sans-serif; 
            background: linear-gradient(135deg, #1565c0 0%, #002f6c 100%); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: 5000; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: opacity 0.5s;
        }
        .star {
            position: absolute; top: 50%; left: 50%; width: 2px; height: 2px;
            background: white; border-radius: 50%; animation: shoot linear infinite;
        }
        @keyframes shoot {
            0% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(1000px); opacity: 0; width: 100px; }
        }
        #app-container { 
            width: 96vw; height: 92vh; background: var(--paper); 
            display: flex; margin: auto; border: 6px double var(--primary); 
            border-radius: 20px; overflow: hidden; z-index: 10;
        }
        .sidebar { width: 160px; background: rgba(255,255,255,0.9); border-right: 2px solid var(--primary); display: flex; flex-direction: column; }
        .sidebar button { padding: 12px; border: none; background: none; font-size: 0.9rem; font-weight: bold; color: var(--primary); cursor: pointer; border-bottom: 1px solid #eee; text-align: left; }
        .sidebar button.active { background: var(--primary); color: white; }
        .sidebar-watermark { margin-top: auto; padding-bottom: 10px; text-align: center; font-size: 10px; color: var(--primary); opacity: 0.5; font-weight: bold; }
        .content { flex: 1; padding: 10px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; position: relative; }
        #feedback-box { font-size: 2rem; height: 1.2em; color: var(--accent); font-weight: bold; margin-bottom: 10px; }
        #pinyin-correct { font-size: 1.5rem; color: var(--pinyin-red); font-weight: bold; margin-top: 10px; }
        .grid-flex { display: flex; gap: 10px; margin: 5px 0; flex-wrap: wrap; justify-content: center; }
        .tian-wrapper { position: relative; width: 160px; height: 160px; background: #fff; border: 2px solid #8b4513; }
        .tianzige { position: absolute; width: 100%; height: 100%; pointer-events: none; opacity: 0.2; background: linear-gradient(45deg, transparent 49%, red 50%, transparent 51%), linear-gradient(-45deg, transparent 49%, red 50%, transparent 51%), linear-gradient(to right, transparent 49%, red 50%, transparent 51%), linear-gradient(to bottom, transparent 49%, red 50% ,transparent 51%); }
        .writer-div { position: absolute; top:0; left:0; width:100%; height:100%; }
        canvas { position: absolute; top:0; left:0; z-index: 5; touch-action: none; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; background: var(--primary); color: #fff; font-weight: bold; margin: 5px; }
        #match-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 95%; }
        .match-item { background: #fff; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.9rem; min-height: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold;}
        .match-item.selected { background: var(--primary); color: white; }
        .match-item.hidden { visibility: hidden; }
        #list-view, #wrong-view { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 95%; }
        .list-card { background:#fff; padding:10px; border-radius:8px; border:1px solid #ddd; display:flex; align-items:center; gap:10px; cursor:pointer; }
        #result-screen { text-align: center; padding: 20px; display: none; }
    </style>
</head>
<body>

<div id="cover-page" onclick="enterApp()">
    <div id="star-container"></div>
    <div style="text-align:center; color:white; z-index:10;">
        <h1 style="font-size:5vw; margin:0;">300 HANZI</h1>
        <h2 style="color:var(--gold); font-size:6vw; margin:0;">HSK 3</h2>
        <p style="letter-spacing:2px; margin-top:20px;">CLICK TO START</p>
    </div>
</div>

<div id="app-container">
    <div class="sidebar">
        <button id="n-learn" class="active" onclick="switchMode('learn')">üìñ Study</button>
        <button id="n-write" onclick="switchMode('write')">‚úçÔ∏è Dictation</button>
        <button id="n-match" onclick="switchMode('match')">üß© Matching</button>
        <button id="n-pinyin" onclick="switchMode('pinyin')">‚å®Ô∏è Pinyin</button>
        <button id="n-list" onclick="switchMode('list')">üìú Word List</button>
        <button id="n-wrong" onclick="switchMode('wrong')" style="color:#d32f2f;">‚ùå Mistake</button>
        <div class="sidebar-watermark">¬© XUSFUNCHINESE</div>
    </div>
    <div class="content">
        <div id="feedback-box"></div>
        <div id="mode-learn" class="view" style="display:flex; flex-direction:column; align-items:center;">
            <div id="s-pinyin" style="color:var(--pinyin-red); font-size:2rem; font-weight:bold;"></div>
            <div id="s-mean" style="font-size:1.2rem; color:#444;"></div>
            <div id="s-grids" class="grid-flex"></div>
            <button class="btn" onclick="nextWord()">Next</button>
        </div>
        <div id="mode-write" class="view" style="display:none; flex-direction:column; align-items:center;">
            <div id="w-mean" style="font-size:1.8rem; font-weight:bold; color:var(--pinyin-red);"></div>
            <div id="w-grids" class="grid-flex"></div>
            <div>
                <button id="ans-btn" class="btn" style="background:var(--gold); color:var(--primary)" onclick="handleAnswer()">Show Answer</button>
                <button class="btn" onclick="nextWord()">Next</button>
            </div>
        </div>
        <div id="mode-match" class="view" style="display:none; width:100%">
            <div id="match-grid"></div>
            <div style="text-align:center; margin-top:10px;">
                <div id="match-progress" style="font-weight:bold; color:var(--primary);"></div>
                <button class="btn" onclick="resetMatchGame()">Reset</button>
            </div>
        </div>
        <div id="mode-pinyin" class="view" style="display:none; flex-direction:column; align-items:center;">
            <h1 id="p-char" style="font-size:5rem; margin:10px;"></h1>
            <input type="text" id="p-input" placeholder="pinyin" style="padding:10px; font-size:1.5rem; text-align:center; width:200px; border:2px solid var(--primary); border-radius:10px;">
            <div id="pinyin-correct" style="display:none;"></div>
            <button class="btn" style="margin-top:15px;" onclick="checkPinyin()">Check</button>
        </div>
        <div id="mode-list" class="view" style="display:none; width:100%"><div id="list-view"></div></div>
        <div id="mode-wrong" class="view" style="display:none; width:100%"><div id="wrong-view"></div></div>
        <div id="result-screen">
            <h2 id="result-text" style="color:var(--primary)"></h2>
            <p>Please subscribe to "Xu's Fun Chinese" on Youtube!</p>
            <button class="btn" onclick="switchMode('learn')">Restart</button>
        </div>
    </div>
</div>

<script>
const vocabulary = [
    {c:"ÈòøÂß®",p:"ƒÅy√≠",m:"aunt"},{c:"Âïä",p:"a",m:"ah"},{c:"ÁüÆ",p:"«éi",m:"short (height)"},{c:"Áà±Â•Ω",p:"√†ih√†o",m:"hobby"},
    {c:"ÂÆâÈùô",p:"ƒÅnj√¨ng",m:"quiet"},{c:"Êää",p:"b«é",m:"(object marker)"},{c:"Áè≠",p:"bƒÅn",m:"class"},{c:"Êê¨",p:"bƒÅn",m:"move (house)"},
    {c:"Âçä",p:"b√†n",m:"half"},{c:"ÂäûÊ≥ï",p:"b√†nf«é",m:"method"},{c:"ÂäûÂÖ¨ÂÆ§",p:"b√†ng≈çngsh√¨",m:"office"},{c:"Â∏ÆÂøô",p:"bƒÅngm√°ng",m:"help"},
    {c:"ÂåÖ",p:"bƒÅo",m:"bag"},{c:"È•±",p:"b«éo",m:"full (after eating)"},{c:"ÂåóÊñπ",p:"bƒõifƒÅng",m:"north"},{c:"Ë¢´",p:"b√®i",m:"(passive marker)"},
    {c:"ÈºªÂ≠ê",p:"b√≠zi",m:"nose"},{c:"ÊØîËæÉ",p:"b«êji√†o",m:"comparatively"},{c:"ÊØîËµõ",p:"b«ês√†i",m:"competition"},{c:"Á¨îËÆ∞Êú¨",p:"b«êj√¨bƒõn",m:"notebook"},
    {c:"ÂøÖÈ°ª",p:"b√¨x≈´",m:"must"},{c:"ÂèòÂåñ",p:"bi√†nhu√†",m:"change"},{c:"Âà´‰∫∫",p:"bi√©ren",m:"others"},{c:"ÂÜ∞ÁÆ±",p:"bƒ´ngxiƒÅng",m:"refrigerator"},
    {c:"ËèúÂçï",p:"c√†idƒÅn",m:"menu"},{c:"ÂèÇÂä†",p:"cƒÅnjiƒÅ",m:"participate"},{c:"Ëçâ",p:"c«éo",m:"grass"},{c:"Â±Ç",p:"c√©ng",m:"floor/layer"},
    {c:"Â∑Æ",p:"ch√†",m:"differ"},{c:"Ë∂ÖÂ∏Ç",p:"chƒÅosh√¨",m:"supermarket"},{c:"Ë°¨Ë°´",p:"ch√®nshƒÅn",m:"shirt"},{c:"ÊàêÁª©",p:"ch√©ngj√¨",m:"grade"},
    {c:"ÂüéÂ∏Ç",p:"ch√©ngsh√¨",m:"city"},{c:"ËøüÂà∞",p:"ch√≠d√†o",m:"be late"},{c:"Èô§‰∫Ü",p:"ch≈´le",m:"except"},{c:"Ëàπ",p:"chu√°n",m:"ship"},
    {c:"Êò•",p:"ch≈´n",m:"spring"},{c:"ËØçÂÖ∏",p:"c√≠di«én",m:"dictionary"},{c:"ËÅ™Êòé",p:"c≈çngming",m:"smart"},{c:"ÊâìÊâ´",p:"d«és«éo",m:"clean"},
    {c:"ÊâìÁÆó",p:"d«ésu√†n",m:"plan"},{c:"Â∏¶",p:"d√†i",m:"bring"},{c:"ÊãÖÂøÉ",p:"dƒÅnxƒ´n",m:"worry"},{c:"ËõãÁ≥ï",p:"d√†ngƒÅo",m:"cake"},
    {c:"ÂΩìÁÑ∂",p:"dƒÅngr√°n",m:"of course"},{c:"Âú∞",p:"de",m:"(adv marker)"},{c:"ÁÅØ",p:"dƒìng",m:"light"},{c:"Âú∞Êñπ",p:"d√¨fang",m:"place"},
    {c:"Âú∞ÈìÅ",p:"d√¨tiƒõ",m:"subway"},{c:"Âú∞Âõæ",p:"d√¨t√∫",m:"map"},{c:"ÁîµÊ¢Ø",p:"di√†ntƒ´",m:"elevator"},{c:"ÁîµÂ≠êÈÇÆ‰ª∂",p:"di√†nz«ê y√≥uji√†n",m:"email"},
    {c:"‰∏ú",p:"d≈çng",m:"east"},{c:"ÂÜ¨",p:"d≈çng",m:"winter"},{c:"Âä®Áâ©",p:"d√≤ngw√π",m:"animal"},{c:"Áü≠",p:"du«én",m:"short (length)"},
    {c:"ÊÆµ",p:"du√†n",m:"section"},{c:"ÈîªÁÇº",p:"du√†nli√†n",m:"exercise"},{c:"Â§ö‰πà",p:"du≈çme",m:"how (adv)"},{c:"È•ø",p:"√®",m:"hungry"},
    {c:"ËÄ≥Êúµ",p:"ƒõrduo",m:"ear"},{c:"ÂèëÁÉß",p:"fƒÅshƒÅo",m:"have a fever"},{c:"ÂèëÁé∞",p:"fƒÅxi√†n",m:"discover"},{c:"Êñπ‰æø",p:"fƒÅngbi√†n",m:"convenient"},
    {c:"Êîæ",p:"f√†ng",m:"put"},{c:"ÊîæÂøÉ",p:"f√†ngxƒ´n",m:"rest assured"},{c:"ÂàÜ",p:"fƒìn",m:"minute"},{c:"ÈôÑËøë",p:"f√πj√¨n",m:"nearby"},
    {c:"Â§ç‰π†",p:"f√πx√≠",m:"review"},{c:"Âπ≤ÂáÄ",p:"gƒÅnj√¨ng",m:"clean"},{c:"ÊÑüÂÖ¥Ë∂£",p:"g«én x√¨ngq√π",m:"be interested in"},{c:"ÊÑüÂÜí",p:"g«énm√†o",m:"catch cold"},
    {c:"ÂàöÊâç",p:"gƒÅngc√°i",m:"just now"},{c:"‰∏™Â≠ê",p:"g√®zi",m:"height"},{c:"Ë∑ü",p:"gƒìn",m:"with"},{c:"Ê†πÊçÆ",p:"gƒìnj√π",m:"according to"},
    {c:"Êõ¥",p:"g√®ng",m:"even more"},{c:"ÂÖ¨Êñ§",p:"g≈çngjƒ´n",m:"kilogram"},{c:"ÂÖ¨Âõ≠",p:"g≈çngyu√°n",m:"park"},{c:"ÊïÖ‰∫ã",p:"g√πshi",m:"story"},
    {c:"ÂàÆÈ£é",p:"guƒÅfƒìng",m:"windy"},{c:"ÂÖ≥",p:"guƒÅn",m:"close"},{c:"ÂÖ≥Á≥ª",p:"guƒÅnx√¨",m:"relationship"},{c:"ÂÖ≥ÂøÉ",p:"guƒÅnxƒ´n",m:"care about"},
    {c:"ÂÖ≥‰∫é",p:"guƒÅny√∫",m:"about"},{c:"ÂõΩÂÆ∂",p:"gu√≥jiƒÅ",m:"country"},{c:"ËøáÂéª",p:"gu√≤q√π",m:"past"},{c:"Ëøá",p:"gu√≤",m:"pass"},
    {c:"ËøòÊòØ",p:"h√°ish√¨",m:"or (in questions)"},{c:"ÂÆ≥ÊÄï",p:"h√†ip√†",m:"afraid"},{c:"ÈªëÊùø",p:"hƒìib«én",m:"blackboard"},{c:"ÂêéÊù•",p:"h√≤ul√°i",m:"later"},
    {c:"Êä§ÁÖß",p:"h√πzh√†o",m:"passport"},{c:"Ëä±",p:"huƒÅ",m:"spend"},{c:"Ëä±",p:"huƒÅ",m:"flower"},{c:"Áîª",p:"hu√†",m:"draw"},
    {c:"Âùè",p:"hu√†i",m:"bad"},{c:"Ê¨¢Ëøé",p:"huƒÅny√≠ng",m:"welcome"},{c:"Ëøò",p:"hu√°n",m:"return"},{c:"ÁéØÂ¢É",p:"hu√°nj√¨ng",m:"environment"},
    {c:"Êç¢",p:"hu√†n",m:"change"},{c:"ÈªÑÊ≤≥",p:"hu√°ngh√©",m:"Yellow River"},{c:"ÂõûÁ≠î",p:"hu√≠d√°",m:"answer"},{c:"‰ºöËÆÆ",p:"hu√¨y√¨",m:"meeting"},
    {c:"ÊàñËÄÖ",p:"hu√≤zhƒõ",m:"or"},{c:"Âá†‰πé",p:"jƒ´h≈´",m:"almost"},{c:"Êú∫‰ºö",p:"jƒ´hu√¨",m:"opportunity"},{c:"ÊûÅ",p:"j√≠",m:"extremely"},
    {c:"ËÆ∞Âæó",p:"j√¨de",m:"remember"},{c:"Â≠£ËäÇ",p:"j√¨ji√©",m:"season"},{c:"Ê£ÄÊü•",p:"ji«énch√°",m:"check"},{c:"ÁÆÄÂçï",p:"ji«éndƒÅn",m:"simple"},
    {c:"ÂÅ•Â∫∑",p:"ji√†nkƒÅng",m:"healthy"},{c:"ËßÅÈù¢",p:"ji√†nmi√†n",m:"meet"},{c:"ËÆ≤",p:"ji«éng",m:"speak"},{c:"Êïô",p:"jiƒÅo",m:"teach"},
    {c:"Ëßí",p:"ji«éo",m:"corner"},{c:"ËÑö",p:"ji«éo",m:"foot"},{c:"Êé•",p:"jiƒì",m:"receive"},{c:"Ë°óÈÅì",p:"jiƒìd√†o",m:"street"},
    {c:"ÁªìÂ©ö",p:"ji√©h≈´n",m:"marry"},{c:"ÁªìÊùü",p:"ji√©sh√π",m:"end"},{c:"ËäÇÁõÆ",p:"ji√©m√π",m:"program"},{c:"ËäÇÊó•",p:"ji√©r√¨",m:"holiday"},
    {c:"Ëß£ÂÜ≥",p:"jiƒõju√©",m:"solve"},{c:"ÂÄü",p:"ji√®",m:"borrow"},{c:"ÁªèÂ∏∏",p:"jƒ´ngch√°ng",m:"often"},{c:"ÁªèËøá",p:"jƒ´nggu√≤",m:"pass by"},
    {c:"ÁªèÁêÜ",p:"jƒ´ngl«ê",m:"manager"},{c:"‰πÖ",p:"ji«î",m:"long time"},{c:"Êóß",p:"ji√π",m:"old"},{c:"Âè•Â≠ê",p:"j√πzi",m:"sentence"},
    {c:"ÂÜ≥ÂÆö",p:"ju√©d√¨ng",m:"decide"},{c:"Ê∏¥",p:"kƒõ",m:"thirsty"},{c:"ÂèØÁà±",p:"kƒõ'√†i",m:"cute"},{c:"Âàª",p:"k√®",m:"quarter (hour)"},
    {c:"ÂÆ¢‰∫∫",p:"k√®r√©n",m:"guest"},{c:"Á©∫Ë∞É",p:"k≈çngti√°o",m:"air conditioner"},{c:"Âè£",p:"k«íu",m:"mouth"},{c:"Âì≠",p:"k≈´",m:"cry"},
    {c:"Ë£§Â≠ê",p:"k√πzi",m:"pants"},{c:"Á≠∑Â≠ê",p:"ku√†izi",m:"chopsticks"},{c:"Ëìù",p:"l√°n",m:"blue"},{c:"ËÄÅ",p:"l«éo",m:"old"},
    {c:"Á¶ªÂºÄ",p:"l√≠kƒÅi",m:"leave"},{c:"Á§ºÁâ©",p:"l«êw√π",m:"gift"},{c:"ÂéÜÂè≤",p:"l√¨sh«ê",m:"history"},{c:"ËÑ∏",p:"li«én",m:"face"},
    {c:"ËÅäÂ§©",p:"li√°otiƒÅn",m:"chat"},{c:"ÁªÉ‰π†",p:"li√†nx√≠",m:"practice"},{c:"ËæÜ",p:"li√†ng",m:"(for vehicles)"},{c:"‰∫ÜËß£",p:"li«éojiƒõ",m:"understand"},
    {c:"ÈÇªÂ±Ö",p:"l√≠nj≈´",m:"neighbor"},{c:"ÁïôÂ≠¶",p:"li√∫xu√©",m:"study abroad"},{c:"Ê•º",p:"l√≥u",m:"building"},{c:"Áªø",p:"l«ú",m:"green"},
    {c:"È©¨",p:"m«é",m:"horse"},{c:"È©¨‰∏ä",p:"m«ésh√†ng",m:"immediately"},{c:"Êª°ÊÑè",p:"m«ény√¨",m:"satisfied"},{c:"Â∏ΩÂ≠ê",p:"m√†ozi",m:"hat"},
    {c:"Á±≥",p:"m«ê",m:"rice"},{c:"Èù¢ÂåÖ",p:"mi√†nbƒÅo",m:"bread"},{c:"ÊòéÁôΩ",p:"m√≠ngbai",m:"understand"},{c:"Êãø",p:"n√°",m:"take"},
    {c:"Â•∂Â•∂",p:"n«éinai",m:"paternal grandma"},{c:"Âçó",p:"n√°n",m:"south"},{c:"Èöæ",p:"n√°n",m:"difficult"},{c:"ÈöæËøá",p:"n√°ngu√≤",m:"sad"},
    {c:"Âπ¥Á∫ß",p:"ni√°nj√≠",m:"grade (school)"},{c:"Âπ¥ËΩª",p:"ni√°nqƒ´ng",m:"young"},{c:"È∏ü",p:"ni«éo",m:"bird"},{c:"Âä™Âäõ",p:"n«îl√¨",m:"hard-working"},
    {c:"Áà¨Â±±",p:"p√°shƒÅn",m:"climb mountain"},{c:"ÁõòÂ≠ê",p:"p√°nzi",m:"plate"},{c:"ËÉñ",p:"p√†ng",m:"fat"},{c:"Âï§ÈÖí",p:"p√≠ji«î",m:"beer"},
    {c:"ÁöÆÈûã",p:"p√≠xi√©",m:"leather shoes"},{c:"Áì∂Â≠ê",p:"p√≠ngzi",m:"bottle"},{c:"ÂÖ∂ÂÆû",p:"q√≠sh√≠",m:"actually"},{c:"ÂÖ∂‰ªñ",p:"q√≠tƒÅ",m:"other"},
    {c:"È™ë",p:"q√≠",m:"ride"},{c:"Â•áÊÄ™",p:"q√≠gu√†i",m:"strange"},{c:"Ëµ∑Êù•",p:"q«êlai",m:"get up"},{c:"Ëµ∑È£û",p:"q«êfƒìi",m:"take off"},
    {c:"Ê∏ÖÊ•ö",p:"qƒ´ngchu",m:"clear"},{c:"ËØ∑ÂÅá",p:"q«êngji√†",m:"ask for leave"},{c:"Áßã",p:"qi≈´",m:"autumn"},{c:"Ë£ôÂ≠ê",p:"q√∫nzi",m:"skirt"},
    {c:"ÁÑ∂Âêé",p:"r√°nh√≤u",m:"then"},{c:"ÁÉ≠ÊÉÖ",p:"r√®q√≠ng",m:"enthusiastic"},{c:"ËÆ§‰∏∫",p:"r√®nw√©i",m:"think"},{c:"ËÆ§Áúü",p:"r√®nzhƒìn",m:"serious"},
    {c:"ÂÆπÊòì",p:"r√≥ngy√¨",m:"easy"},{c:"Â¶ÇÊûú",p:"r√∫gu«í",m:"if"},{c:"‰ºû",p:"s«én",m:"umbrella"},{c:"‰∏äÁΩë",p:"sh√†ngw«éng",m:"go online"},
    {c:"ÁîüÊ∞î",p:"shƒìngq√¨",m:"angry"},{c:"Â£∞Èü≥",p:"shƒìngyƒ´n",m:"sound"},{c:"ËØï",p:"sh√¨",m:"try"},{c:"‰∏ñÁïå",p:"sh√¨ji√®",m:"world"},
    {c:"Áò¶",p:"sh√≤u",m:"thin"},{c:"ËàíÊúç",p:"sh≈´fu",m:"comfortable"},{c:"ÂèîÂèî",p:"sh≈´shu",m:"uncle"},{c:"Ê†ë",p:"sh√π",m:"tree"},
    {c:"Êï∞Â≠¶",p:"sh√πxu√©",m:"math"},{c:"Âà∑Áâô",p:"shuƒÅy√°",m:"brush teeth"},{c:"Âèå",p:"shuƒÅng",m:"pair"},{c:"Ê∞¥Âπ≥",p:"shu«êp√≠ng",m:"level"},
    {c:"Âè∏Êú∫",p:"sƒ´jƒ´",m:"driver"},{c:"Â§™Èò≥",p:"t√†iy√°ng",m:"sun"},{c:"ÁâπÂà´",p:"t√®bi√©",m:"especially"},{c:"Áñº",p:"t√©ng",m:"hurt"},
    {c:"ÊèêÈ´ò",p:"t√≠gƒÅo",m:"improve"},{c:"‰ΩìËÇ≤",p:"t«êy√π",m:"PE"},{c:"Áîú",p:"ti√°n",m:"sweet"},{c:"Êù°",p:"ti√°o",m:"(long thin things)"},
    {c:"Âêå‰∫ã",p:"t√≥ngsh√¨",m:"colleague"},{c:"ÂêåÊÑè",p:"t√≥ngy√¨",m:"agree"},{c:"Â§¥Âèë",p:"t√≥ufa",m:"hair"},{c:"Á™ÅÁÑ∂",p:"t≈´r√°n",m:"suddenly"},
    {c:"Âõæ‰π¶È¶Ü",p:"t√∫sh≈´gu«én",m:"library"},{c:"ËÖø",p:"tu«ê",m:"leg"},{c:"ÂÆåÊàê",p:"w√°nch√©ng",m:"complete"},{c:"Á¢ó",p:"w«én",m:"bowl"},
    {c:"‰∏á",p:"w√†n",m:"ten thousand"},{c:"ÂøòËÆ∞",p:"w√†ngj√¨",m:"forget"},{c:"‰∏∫",p:"w√®i",m:"for"},{c:"‰∏∫‰∫Ü",p:"w√®ile",m:"in order to"},
    {c:"‰Ωç",p:"w√®i",m:"(polite measure)"},{c:"ÊñáÂåñ",p:"w√©nhu√†",m:"culture"},{c:"Ë•ø",p:"xƒ´",m:"west"},{c:"‰π†ÊÉØ",p:"x√≠gu√†n",m:"habit"},
    {c:"Ê¥óÊâãÈó¥",p:"x«êsh«íujiƒÅn",m:"restroom"},{c:"Ê¥óÊæ°",p:"x«êz«éo",m:"take a shower"},{c:"Â§è",p:"xi√†",m:"summer"},{c:"ÂÖà",p:"xiƒÅn",m:"first"},
    {c:"È¶ôËïâ",p:"xiƒÅngjiƒÅo",m:"banana"},{c:"Áõ∏‰ø°",p:"xiƒÅngx√¨n",m:"believe"},{c:"Âêë",p:"xi√†ng",m:"towards"},{c:"ÂÉè",p:"xi√†ng",m:"resemble"},
    {c:"Â∞èÂøÉ",p:"xi«éoxƒ´n",m:"be careful"},{c:"Ê†°Èïø",p:"xi√†ozh«éng",m:"principal"},{c:"Êñ∞Èóª",p:"xƒ´nw√©n",m:"news"},{c:"Êñ∞È≤ú",p:"xƒ´nxiƒÅn",m:"fresh"},
    {c:"‰ø°Áî®Âç°",p:"x√¨ny√≤ngk«é",m:"credit card"},{c:"Ë°åÊùéÁÆ±",p:"x√≠nglixiƒÅng",m:"suitcase"},{c:"ÁÜäÁå´",p:"xi√≥ngmƒÅo",m:"panda"},{c:"ÈúÄË¶Å",p:"x≈´y√†o",m:"need"},
    {c:"ÈÄâÊã©",p:"xu«énz√©",m:"choose"},{c:"Ë¶ÅÊ±Ç",p:"yƒÅoqi√∫",m:"require"},{c:"Áà∑Áà∑",p:"y√©ye",m:"grandpa"},{c:"‰∏ÄÂÆö",p:"y√≠d√¨ng",m:"certainly"},
    {c:"‰∏ÄÂÖ±",p:"y√≠g√≤ng",m:"altogether"},{c:"‰∏Ä‰ºöÂÑø",p:"y√≠hu√¨r",m:"a while"},{c:"‰∏ÄÊ†∑",p:"y√≠y√†ng",m:"same"},{c:"‰ª•Ââç",p:"y«êqi√°n",m:"before"},
    {c:"‰∏ÄËà¨",p:"y√¨bƒÅn",m:"generally"},{c:"‰∏ÄËæπ",p:"y√¨biƒÅn",m:"at the same time"},{c:"‰∏ÄÁõ¥",p:"y√¨zh√≠",m:"always"},{c:"Èü≥‰πê",p:"yƒ´nyu√®",m:"music"},
    {c:"Èì∂Ë°å",p:"y√≠nh√°ng",m:"bank"},{c:"È•ÆÊñô",p:"y«ênli√†o",m:"beverage"},{c:"Â∫îËØ•",p:"yƒ´nggƒÅi",m:"should"},{c:"ÂΩ±Âìç",p:"y«êngxi«éng",m:"influence"},
    {c:"Áî®",p:"y√≤ng",m:"use"},{c:"Ê∏∏Êàè",p:"y√≥ux√¨",m:"game"},{c:"ÊúâÂêç",p:"y«íum√≠ng",m:"famous"},{c:"Âèà",p:"y√≤u",m:"again"},
    {c:"ÈÅáÂà∞",p:"y√πd√†o",m:"meet (by chance)"},{c:"ÂÖÉ",p:"yu√°n",m:"yuan"},{c:"ÊÑøÊÑè",p:"yu√†ny√¨",m:"willing"},{c:"Êúà‰∫Æ",p:"yu√®liang",m:"moon"},
    {c:"Ë∂ä",p:"yu√®",m:"the more..."},{c:"Á´ô",p:"zh√†n",m:"stand"},{c:"Âº†",p:"zhƒÅng",m:"(measure for paper)"},{c:"Èïø",p:"zh«éng",m:"grow"},
    {c:"ÁùÄÊÄ•",p:"zh√°oj√≠",m:"anxious"},{c:"ÁÖßÈ°æ",p:"zh√†og√π",m:"take care of"},{c:"ÁÖßÁâá",p:"zh√†opi√†n",m:"photo"},{c:"ÁÖßÁõ∏Êú∫",p:"zh√†oxi√†ngjƒ´",m:"camera"},
    {c:"Âè™",p:"zhƒ´",m:"only"},{c:"‰∏≠Êñá",p:"zh≈çngw√©n",m:"Chinese"},{c:"‰∏≠Èó¥",p:"zh≈çngjiƒÅn",m:"middle"},{c:"Áªà‰∫é",p:"zh≈çngy√∫",m:"finally"},
    {c:"Áßç",p:"zh«íng",m:"kind"},{c:"ÈáçË¶Å",p:"zh√≤ngy√†o",m:"important"},{c:"Âë®Êú´",p:"zh≈çum√≤",m:"weekend"},{c:"‰∏ªË¶Å",p:"zh«îy√†o",m:"main"},
    {c:"Ê≥®ÊÑè",p:"zh√πy√¨",m:"pay attention"},{c:"Ëá™Â∑±",p:"z√¨j«ê",m:"oneself"},{c:"Ëá™Ë°åËΩ¶",p:"z√¨x√≠ngchƒì",m:"bicycle"},{c:"ÊÄªÊòØ",p:"z«íngsh√¨",m:"always"},
    {c:"Âò¥",p:"zu«ê",m:"mouth"},{c:"ÊúÄÂêé",p:"zu√¨h√≤u",m:"finally"},{c:"ÊúÄËøë",p:"zu√¨j√¨n",m:"recently"},{c:"‰Ωú‰∏ö",p:"zu√≤y√®",m:"homework"}
];

let curIdx = 0, writers = [], ansShow = false, wrongAnswers = [];
let matchPool = [], matchedCount = 0, selectedMatch = [];

function cleanup() {
    writers.forEach(w => { if(w && w.destroy) w.destroy(); });
    writers = [];
    document.getElementById('s-grids').innerHTML = '';
    document.getElementById('w-grids').innerHTML = '';
}

function switchMode(m, idx = 0) {
    cleanup();
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    if(document.getElementById('n-'+m)) document.getElementById('n-'+m).classList.add('active');
    document.querySelectorAll('.view, #result-screen').forEach(v => v.style.display = 'none');
    
    const target = document.getElementById('mode-'+m);
    if(target) target.style.display = (['list', 'match', 'wrong'].includes(m)) ? 'block' : 'flex';
    
    curIdx = idx;
    requestAnimationFrame(() => {
        if(m==='list') renderList();
        else if(m==='match') resetMatchGame();
        else if(m==='wrong') renderWrong();
        else updateUI();
    });
}

function updateUI() {
    const item = vocabulary[curIdx];
    document.getElementById('feedback-box').innerText = '';
    document.getElementById('pinyin-correct').style.display = 'none';
    document.getElementById('pinyin-correct').innerText = '';
    
    const isLearn = document.getElementById('mode-learn').style.display !== 'none';
    const isWrite = document.getElementById('mode-write').style.display !== 'none';

    if(isLearn) {
        document.getElementById('s-pinyin').innerText = item.p;
        document.getElementById('s-mean').innerText = item.m;
        [...item.c].forEach((char, i) => {
            const wrap = createGrid(char, 'study', i);
            document.getElementById('s-grids').appendChild(wrap);
            const w = HanziWriter.create(wrap.querySelector('.writer-div'), char, { width:160, height:160, padding:5, strokeColor:'#2f3542' });
            writers.push(w);
            wrap.onclick = () => { speak(char); w.animateCharacter(); };
        });
    }

    if(isWrite) {
        document.getElementById('w-mean').innerText = item.m;
        ansShow = false; document.getElementById('ans-btn').innerText = "Show Answer";
        [...item.c].forEach((char, i) => {
            const wrap = createGrid(char, 'write', i);
            document.getElementById('w-grids').appendChild(wrap);
            initCanvas(wrap.querySelector('canvas'));
        });
    }
    document.getElementById('p-char').innerText = item.c;
    document.getElementById('p-input').value = '';
}

function createGrid(char, mode, idx) {
    const w = document.createElement('div'); w.className = 'tian-wrapper';
    w.innerHTML = `<div class="tianzige"></div><div class="writer-div"></div>`;
    if(mode === 'write') w.innerHTML += `<canvas width="160" height="160"></canvas>`;
    return w;
}

function initCanvas(can) {
    const ctx = can.getContext('2d');
    let drawing = false; ctx.strokeStyle = "red"; ctx.lineWidth = 8; ctx.lineCap = "round";
    const getP = (e) => { 
        const r = can.getBoundingClientRect(); 
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    };
    const start = (e) => { e.preventDefault(); drawing = true; const p = getP(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    const move = (e) => { if(!drawing) return; const p = getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
    const end = () => { drawing = false; };
    can.addEventListener('touchstart', start); can.addEventListener('touchmove', move); can.addEventListener('touchend', end);
    can.addEventListener('mousedown', start); can.addEventListener('mousemove', move); can.addEventListener('mouseup', end);
}

function handleAnswer() {
    ansShow = !ansShow;
    const item = vocabulary[curIdx];
    document.getElementById('ans-btn').innerText = ansShow ? "Hide Answer" : "Show Answer";
    const grids = document.querySelectorAll('#w-grids .writer-div');
    grids.forEach((g, i) => {
        g.innerHTML = '';
        if(ansShow) HanziWriter.create(g, item.c[i], { width: 160, height: 160, padding: 5, strokeColor: '#ccc' });
    });
}

function resetMatchGame() {
    matchPool = [...vocabulary].sort(() => 0.5 - Math.random());
    matchedCount = 0;
    initMatchRound();
}

function initMatchRound() {
    const g = document.getElementById('match-grid'); g.innerHTML = ''; selectedMatch = [];
    document.getElementById('match-progress').innerText = `Progress: ${matchedCount}/300`;
    const roundItems = matchPool.slice(0, 4);
    if(!roundItems.length) { showFinal(); return; }
    let items = [];
    roundItems.forEach(v => {
        items.push({t: v.c, id: v.c}, {t: v.p, id: v.c}, {t: v.m, id: v.c});
    });
    items.sort(() => 0.5 - Math.random()).forEach(it => {
        const d = document.createElement('div'); d.className = 'match-item'; d.innerText = it.t;
        d.onclick = () => {
            if(d.classList.contains('selected') || d.classList.contains('hidden')) return;
            d.classList.add('selected'); selectedMatch.push({el: d, id: it.id});
            if(selectedMatch.length === 3) {
                if(selectedMatch[0].id === selectedMatch[1].id && selectedMatch[1].id === selectedMatch[2].id) {
                    speak(selectedMatch[0].id);
                    selectedMatch.forEach(s => s.el.classList.add('hidden'));
                    if(!document.querySelector('.match-item:not(.hidden)')) {
                        matchedCount += roundItems.length;
                        matchPool.splice(0, 4);
                        setTimeout(initMatchRound, 500);
                    }
                } else { setTimeout(() => { selectedMatch.forEach(s => s.el.classList.remove('selected')); selectedMatch = []; }, 500); }
                selectedMatch = [];
            }
        };
        g.appendChild(d);
    });
}

function checkPinyin() {
    const input = document.getElementById('p-input').value.toLowerCase().trim();
    const item = vocabulary[curIdx];
    const correct = item.p.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "");
    const cleanInput = input.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "");

    document.getElementById('pinyin-correct').style.display = 'none';

    if(cleanInput === correct) {
        document.getElementById('feedback-box').innerText = 'üëç Good!';
        if(!wrongAnswers.includes(item)) wrongAnswers = wrongAnswers.filter(w => w !== item); // remove if previously wrong
    } else {
        document.getElementById('feedback-box').innerText = '‚ùå Wrong';
        document.getElementById('pinyin-correct').innerText = `Ê≠£Á°ÆÊãºÈü≥Ôºö${item.p}`;
        document.getElementById('pinyin-correct').style.display = 'block';
        if(!wrongAnswers.includes(item)) wrongAnswers.push(item);
    }

    setTimeout(() => {
        if(curIdx >= 299) {
            showFinal();
        } else {
            nextWord();
        }
    }, 1200);
}

function nextWord() { 
    curIdx = (curIdx + 1) % 300; 
    cleanup(); 
    updateUI(); 
}

function showFinal() {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById('result-screen').style.display = 'block';
    const praises = ["Â§™Ê£í‰∫ÜÔºÅ", "HSK3 ÂÆåÊàêÔºÅ", "‰Ω†ÁúüÂéâÂÆ≥ÔºÅ", "ÈùûÂ∏∏Âá∫Ëâ≤ÔºÅ"];
    const text = praises[Math.floor(Math.random()*praises.length)];
    document.getElementById('result-text').innerText = text;
    speak(text);
}

function renderList() {
    document.getElementById('list-view').innerHTML = vocabulary.map((v, i) => `
        <div class="list-card" onclick="switchMode('learn', ${i})">
            <b style="font-size:1.5rem;">${v.c}</b>
            <div><span style="color:var(--pinyin-red); font-weight:bold; font-size:1.1rem;">${v.p}</span><br><small>${v.m}</small></div>
        </div>`).join('');
}

function renderWrong() {
    const container = document.getElementById('wrong-view');
    if(!wrongAnswers.length) { 
        container.innerHTML = "<p style='text-align:center; padding:20px;'>No mistakes yet! Keep practicing!</p>"; 
        return; 
    }
    container.innerHTML = wrongAnswers.map(v => {
        const idx = vocabulary.findIndex(it => it.c === v.c);
        return `<div class="list-card" onclick="switchMode('learn', ${idx})"><b>${v.c}</b><div><span style="color:var(--pinyin-red); font-weight:bold;">${v.p}</span><br><small>${v.m}</small></div></div>`;
    }).join('');
}

function speak(t) { 
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t); 
        m.lang = 'zh-CN'; m.rate = 0.8; 
        window.speechSynthesis.speak(m); 
    }
}

function enterApp() { 
    document.getElementById('cover-page').style.opacity = '0'; 
    setTimeout(() => { 
        document.getElementById('cover-page').style.display = 'none'; 
        switchMode('learn'); 
    }, 500); 
}

window.onload = () => {
    const container = document.getElementById('star-container');
    for(let i=0; i<50; i++) {
        let s = document.createElement('div'); s.className = 'star';
        s.style.setProperty('--angle', Math.random() * 360 + 'deg');
        s.style.animationDuration = Math.random() * 1 + 1 + 's';
        container.appendChild(s);
    }
};
</script>
</body>
</html>