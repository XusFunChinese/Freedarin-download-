<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSK1 Hanzi 2 - XUSFUNCHINESE</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        :root { 
            --pinyin-red: #ff0000; 
            --paper: #ffffff; 
            --gold: #ffd700; 
            --primary: #01579b;
            --night-sky: radial-gradient(circle at center, #001f3f 0%, #000510 100%);
            --grid-size: 220px;
        }
        * { box-sizing: border-box; }
        body { 
            margin: 0; font-family: "Arial", sans-serif; 
            background: #000; height: 100vh; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }

        /* Ê∞¥Âç∞Â±ÇÁ∫ß Z-index: 5 */
        .watermark-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5; 
            display: flex; flex-wrap: wrap; justify-content: flex-start;
            align-content: flex-start; padding: 20px; gap: 40px;
            opacity: 0.12; 
        }
        .watermark-layer span {
            font-size: 1.5rem; color: #ffffff; font-weight: bold;
            white-space: nowrap;
        }

        /* Â∞ÅÈù¢Ê†∑Âºè */
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: 5000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: white; transition: 0.5s;
        }
        .cover-title { font-size: 4.5rem; margin: 0; font-weight: 900; letter-spacing: 2px; }
        .mode-selection { margin-top: 50px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .mode-btn { 
            padding: 18px 45px; font-size: 1.4rem; border: 3px solid var(--gold); 
            background: transparent; color: white; border-radius: 60px; cursor: pointer;
            transition: 0.3s; font-weight: bold; width: 340px;
        }
        .mode-btn:hover { background: var(--gold); color: #000; }

        /* ‰∏ªÂÆπÂô® Z-index: 10 */
        #app-container { 
            width: 100%; max-width: 500px; height: 100%; 
            background: var(--paper); display: flex; flex-direction: column; 
            position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.9); 
            z-index: 10;
        }

        .sidebar { 
            width: 100%; background: #f0f0f0; display: flex; flex-wrap: wrap;
            border-bottom: 2px solid var(--primary); z-index: 100;
        }
        .sidebar button { 
            flex: 1 1 33.33%; padding: 12px 5px; border: 0.5px solid #ddd;
            background: none; font-size: 0.8rem; font-weight: bold; 
            color: var(--primary); cursor: pointer;
        }
        .sidebar button.active { background: var(--primary); color: white; }

        .instruction { font-size: 0.8rem; color: #7f8c8d; font-style: italic; margin-bottom: 8px; text-align: center; }

        .content { 
            flex: 1; padding: 15px; display: flex; flex-direction: column; 
            align-items: center; overflow-y: auto; width: 100%; background: #fff;
        }
        #feedback-box { font-size: 1.4rem; height: 1.5em; color: #2ecc71; font-weight: bold; margin-bottom: 5px; }
        
        .grid-flex { display: flex; gap: 15px; margin: 10px 0; flex-wrap: wrap; justify-content: center; width: 100%; }
        .tian-wrapper { position: relative; width: var(--grid-size); height: var(--grid-size); border: 2px solid #8b4513; background: #fff; }
        .tianzige { position: absolute; width: 100%; height: 100%; pointer-events: none; opacity: 0.15; background: 
            linear-gradient(45deg, transparent 49%, red 50%, transparent 51%), 
            linear-gradient(-45deg, transparent 49%, red 50%, transparent 51%), 
            linear-gradient(to right, transparent 49%, red 50%, transparent 51%), 
            linear-gradient(to bottom, transparent 49%, red 50% ,transparent 51%); }
        .writer-div { position: absolute; top:0; left:0; width:100%; height:100%; }
        canvas { position: absolute; top:0; left:0; z-index: 5; touch-action: none; }

        .btn { padding: 12px 30px; border-radius: 25px; border: none; cursor: pointer; background: var(--primary); color: #fff; font-weight: bold; margin: 10px; font-size: 1rem; }

        .list-card { background:#fff; padding:15px; border-radius:12px; border:1px solid #ddd; display:flex; align-items:center; gap:15px; width: 100%; margin-bottom:10px; cursor: pointer;}
        .list-pinyin { color: var(--pinyin-red); font-weight: bold; font-size: 1.2rem; }

        .star { position: absolute; top: 50%; left: 50%; width: 2px; height: 2px; background: white; border-radius: 50%; animation: shoot linear infinite; z-index: 1; }
        @keyframes shoot { 0% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(0); opacity: 1; } 100% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(1000px); opacity: 0; width: 100px; } }
    </style>
</head>
<body>

<div class="watermark-layer" id="wm-container"></div>

<div id="cover-page">
    <div id="star-container"></div>
    <div style="z-index:10;">
        <h1 class="cover-title">HSK1 Hanzi 2</h1>
        <div class="mode-selection">
            <button class="mode-btn" onclick="enterApp('portrait')">üì± PORTRAIT MODE</button>
            <button class="mode-btn" onclick="enterApp('landscape')">üñºÔ∏è LANDSCAPE MODE</button>
        </div>
    </div>
</div>

<div id="app-container" style="display:none;">
    <div class="sidebar">
        <button id="n-learn" class="active" onclick="switchMode('learn')">üìñ LEARN</button>
        <button id="n-write" onclick="switchMode('write')">‚úçÔ∏è DICTATION</button>
        <button id="n-match" onclick="switchMode('match')">üß© MATCHING</button>
        <button id="n-pinyin" onclick="switchMode('pinyin')">‚å®Ô∏è PINYIN</button>
        <button id="n-list" onclick="switchMode('list')">üìú LIST</button>
        <button id="n-wrong" onclick="switchMode('wrong')">‚ùå MISTAKES</button>
    </div>
    
    <div class="content">
        <div id="feedback-box"></div>
        
        <div id="mode-learn" class="view" style="display:flex; flex-direction:column; align-items:center; width:100%;">
            <p class="instruction">Tap the character to see stroke order and hear pronunciation.</p>
            <div id="s-pinyin" style="color:var(--pinyin-red); font-size:2.8rem; font-weight:bold;"></div>
            <div id="s-mean" style="font-size:1.4rem; color:#666; margin-bottom:15px;"></div>
            <div id="s-grids" class="grid-flex"></div>
            <button class="btn" onclick="nextWord()">Next Word</button>
        </div>

        <div id="mode-write" class="view" style="display:none; flex-direction:column; align-items:center; width:100%;">
            <p class="instruction">Listen to the meaning and write the characters in the grids.</p>
            <div id="w-mean" style="font-size:2.5rem; font-weight:bold; color:var(--pinyin-red);"></div>
            <div id="w-grids" class="grid-flex"></div>
            <div style="display:flex; gap:10px;">
                <button id="ans-btn" class="btn" style="background:#f39c12;" onclick="handleAnswer()">Check Answer</button>
                <button class="btn" onclick="nextWord()">Next Word</button>
            </div>
        </div>

        <div id="mode-match" class="view" style="display:none; width:100%">
            <p class="instruction">Match the Hanzi, Pinyin, and Meaning of the same word.</p>
            <div id="match-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
            <div style="text-align:center; margin-top:20px;">
                <p id="match-progress" style="font-weight:bold; color:var(--primary);"></p>
                <button class="btn" onclick="resetMatchGame()">Reset Game</button>
            </div>
        </div>

        <div id="mode-pinyin" class="view" style="display:none; flex-direction:column; align-items:center; width:100%;">
            <p class="instruction">Type the Pinyin for the character below (without tones).</p>
            <h1 id="p-char" style="font-size:6rem; margin:20px 0;"></h1>
            <input type="text" id="p-input" placeholder="Enter pinyin..." style="padding:15px; font-size:1.5rem; text-align:center; width:80%; border:3px solid var(--primary); border-radius:10px;">
            <button class="btn" onclick="checkPinyin()" style="width:80%;">Submit</button>
        </div>

        <div id="mode-list" class="view" style="display:none; width:100%"><div id="list-view"></div></div>
        <div id="mode-wrong" class="view" style="display:none; width:100%"><div id="wrong-view"></div></div>

        <div id="result-screen" style="display:none; text-align:center;">
            <h2 style="color:var(--primary); font-size:2.5rem;">Well Done! üéâ</h2>
            <p>You have finished all 100 new words.</p>
            <button class="btn" onclick="location.reload()">Restart</button>
        </div>
    </div>
</div>

<script>
// HSK1 Ââ©‰Ωô 100 ËØç (Part 2)
const vocabulary = [
    {c:"‰∏Ä", p:"yƒ´", m:"one", e:"1Ô∏è‚É£"}, {c:"‰∫å", p:"√®r", m:"two", e:"2Ô∏è‚É£"}, {c:"‰∏â", p:"sƒÅn", m:"three", e:"3Ô∏è‚É£"}, {c:"Âõõ", p:"s√¨", m:"four", e:"4Ô∏è‚É£"}, {c:"‰∫î", p:"w«î", m:"five", e:"5Ô∏è‚É£"},
    {c:"ÂÖ≠", p:"li√π", m:"six", e:"6Ô∏è‚É£"}, {c:"‰∏É", p:"qƒ´", m:"seven", e:"7Ô∏è‚É£"}, {c:"ÂÖ´", p:"bƒÅ", m:"eight", e:"8Ô∏è‚É£"}, {c:"‰πù", p:"ji«î", m:"nine", e:"9Ô∏è‚É£"}, {c:"ÂçÅ", p:"sh√≠", m:"ten", e:"üîü"},
    {c:"Èõ∂", p:"l√≠ng", m:"zero", e:"0Ô∏è‚É£"}, {c:"‰∏™", p:"g√®", m:"measure word", e:"üì¶"}, {c:"Â≤Å", p:"su√¨", m:"years old", e:"üéÇ"}, {c:"Êú¨", p:"bƒõn", m:"m.w. books", e:"üìó"}, {c:"‰∫õ", p:"xiƒì", m:"some", e:"üç±"},
    {c:"Âùó", p:"ku√†i", m:"m.w. money", e:"üí∞"}, {c:"Â§ß", p:"d√†", m:"big", e:"üêò"}, {c:"Â∞è", p:"xi«éo", m:"small", e:"üê≠"}, {c:"Â§ö", p:"du≈ç", m:"many", e:"üìà"}, {c:"Â∞ë", p:"sh«éo", m:"few", e:"üìâ"},
    {c:"ÂÜ∑", p:"lƒõng", m:"cold", e:"‚ùÑÔ∏è"}, {c:"ÁÉ≠", p:"r√®", m:"hot", e:"üî•"}, {c:"È´òÂÖ¥", p:"gƒÅox√¨ng", m:"happy", e:"üòÑ"}, {c:"ÊºÇ‰∫Æ", p:"pi√†oliang", m:"pretty", e:"üå∏"}, {c:"Áúã", p:"k√†n", m:"look", e:"üëÅÔ∏è"},
    {c:"Âê¨", p:"tƒ´ng", m:"listen", e:"üëÇ"}, {c:"ËØ¥ËØù", p:"shu≈çhu√†", m:"speak", e:"üó£Ô∏è"}, {c:"ËØª", p:"d√∫", m:"read", e:"üìñ"}, {c:"ÂÜô", p:"xiƒõ", m:"write", e:"‚úçÔ∏è"}, {c:"ÁúãËßÅ", p:"k√†nji√†n", m:"see", e:"üëÄ"},
    {c:"Âè´", p:"ji√†o", m:"called", e:"üì¢"}, {c:"Êù•", p:"l√°i", m:"come", e:"üèÉ"}, {c:"Âõû", p:"hu√≠", m:"return", e:"üîô"}, {c:"Âéª", p:"q√π", m:"go", e:"üö∂"}, {c:"ÂêÉ", p:"chƒ´", m:"eat", e:"üçï"},
    {c:"Âñù", p:"hƒì", m:"drink", e:"‚òï"}, {c:"Áù°Ëßâ", p:"shu√¨ji√†o", m:"sleep", e:"üò¥"}, {c:"ÂÅö", p:"zu√≤", m:"do/make", e:"üõ†Ô∏è"}, {c:"‰π∞", p:"m«éi", m:"buy", e:"üõí"}, {c:"ÂºÄ", p:"kƒÅi", m:"open/drive", e:"üöó"},
    {c:"Âùê", p:"zu√≤", m:"sit", e:"ü™ë"}, {c:"‰Ωè", p:"zh√π", m:"live/stay", e:"üè®"}, {c:"Â≠¶‰π†", p:"xu√©x√≠", m:"study", e:"üìö"}, {c:"Â∑•‰Ωú", p:"g≈çngzu√≤", m:"work", e:"üíº"}, {c:"‰∏ãÈõ®", p:"xi√†y«î", m:"rain", e:"üåßÔ∏è"},
    {c:"Áà±", p:"√†i", m:"love", e:"‚ù§Ô∏è"}, {c:"ÂñúÊ¨¢", p:"x«êhuan", m:"like", e:"üòä"}, {c:"ÊÉ≥", p:"xi«éng", m:"want/think", e:"ü§î"}, {c:"ËÆ§ËØÜ", p:"r√®nshi", m:"know", e:"ü§ù"}, {c:"‰ºö", p:"hu√¨", m:"can/will", e:"üß†"},
    {c:"ËÉΩ", p:"n√©ng", m:"can/able", e:"üí™"}, {c:"ÊÄé‰πà", p:"zƒõnme", m:"how", e:"‚ùì"}, {c:"ÊÄé‰πàÊ†∑", p:"zƒõnmey√†ng", m:"how about", e:"ü§∑"}, {c:"Â§öÂ∞ë", p:"du≈çsh«éo", m:"how many", e:"üî¢"}, {c:"Âá†", p:"j«ê", m:"how many", e:"üñêÔ∏è"},
    {c:"Âì™ÂÑø", p:"n«ér", m:"where", e:"üìç"}, {c:"‰ªÄ‰πà", p:"sh√©nme", m:"what", e:"ü§î"}, {c:"Ë∞Å", p:"sh√©i", m:"who", e:"üë§"}, {c:"Â§™", p:"t√†i", m:"too/very", e:"ü§©"}, {c:"ÈÉΩ", p:"d≈çu", m:"both/all", e:"üë¨"},
    {c:"Âà´", p:"bi√©", m:"don't", e:"üö´"}, {c:"ÈùûÂ∏∏", p:"fƒìich√°ng", m:"very", e:"‚ú®"}, {c:"ËøôÈáå", p:"zh√®l«ê", m:"here", e:"üëá"}, {c:"ÂêçÂ≠ó", p:"m√≠ngzi", m:"name", e:"üÜî"}, {c:"Â§©Ê∞î", p:"tiƒÅnq√¨", m:"weather", e:"‚òÅÔ∏è"},
    {c:"Ë∫´‰Ωì", p:"shƒìnt«ê", m:"body", e:"üí™"}, {c:"ÁîµÂΩ±", p:"di√†ny«êng", m:"movie", e:"üé¨"}, {c:"ÁîµËßÜ", p:"di√†nsh√¨", m:"TV", e:"üì∫"}, {c:"ÁîµËÑë", p:"di√†nn«éo", m:"PC", e:"üíª"}, {c:"ÈÇ£", p:"n√†", m:"that", e:"üëà"},
    {c:"Ëøô", p:"zh√®", m:"this", e:"üëâ"}, {c:"ÂêéÈù¢", p:"h√≤umi√†n", m:"back", e:"‚¨áÔ∏è"}, {c:"ÂâçÈù¢", p:"qi√°nmi√†n", m:"front", e:"‚¨ÜÔ∏è"}, {c:"‰∏äÈù¢", p:"sh√†ngmi√†n", m:"up", e:"üîù"}, {c:"‰∏ãÈù¢", p:"xi√†mi√†n", m:"down", e:"üëá"},
    {c:"‰∏úË•ø", p:"d≈çngxi", m:"thing", e:"üì¶"}, {c:"Ë°£Êúç", p:"yƒ´fu", m:"clothes", e:"üëï"}, {c:"Ê∞¥Êûú", p:"shu«êgu«í", m:"fruit", e:"üçé"}, {c:"Ëèú", p:"c√†i", m:"dish/veg", e:"ü•ó"}, {c:"È£ûÊú∫", p:"fƒìijƒ´", m:"plane", e:"‚úàÔ∏è"},
    {c:"Âá∫ÁßüËΩ¶", p:"ch≈´z≈´chƒì", m:"taxi", e:"üöï"}, {c:"ÂàÜÈíü", p:"fƒìnzh≈çng", m:"minute", e:"‚è≤Ô∏è"}, {c:"Âπ¥", p:"ni√°n", m:"year", e:"üóìÔ∏è"}, {c:"Âè∑", p:"h√†o", m:"date", e:"üìÜ"}, {c:"ÊòüÊúü", p:"xƒ´ngqƒ´", m:"week", e:"üìÖ"},
    {c:"‰∏äÂçà", p:"sh√†ngw«î", m:"morning", e:"‚òÄÔ∏è"}, {c:"‰∏≠Âçà", p:"zh≈çngw«î", m:"noon", e:"üïõ"}, {c:"‰∏ãÂçà", p:"xi√†w«î", m:"afternoon", e:"üå§Ô∏è"}, {c:"ÁÇπ", p:"di«én", m:"o'clock", e:"‚è∞"}, {c:"ÂàÜÈíü", p:"fƒìnzh≈çng", m:"minute", e:"‚åö"},
    {c:"Èí±", p:"qi√°n", m:"money", e:"üí∞"}, {c:"Èù¢Êù°", p:"mi√†nti√°o", m:"noodles", e:"üçú"}, {c:"ÁÅ´ËΩ¶Á´ô", p:"hu«íchƒìzh√†n", m:"station", e:"üöâ"}, {c:"Â∞èÂßê", p:"xi«éojiƒõ", m:"Miss", e:"üë©"}, {c:"ÂÖàÁîü", p:"xiƒÅnsheng", m:"Mr", e:"üë®"},
    {c:"Âåó‰∫¨", p:"bƒõijƒ´ng", m:"Beijing", e:"‚õ©Ô∏è"}, {c:"ÂåªÁîü", p:"yƒ´shƒìng", m:"doctor", e:"üë®‚Äç‚öïÔ∏è"}, {c:"ÂïÜÂ∫ó", p:"shƒÅngdi√†n", m:"shop", e:"üè™"}, {c:"ÂåªÈô¢", p:"yƒ´yu√†n", m:"hospital", e:"üè•"}, {c:"ÂÑøÂ≠ê", p:"√©rzi", m:"son", e:"üë¶"}
];

let curIdx = 0, writers = [], ansShow = false, wrongAnswers = [];
let matchPool = [], matchedCount = 0, selectedMatch = [];
let isLandscape = false;

function enterApp(mode) { 
    if(mode === 'landscape') { document.getElementById('app-container').style.maxWidth = '900px'; isLandscape = true; }
    document.getElementById('cover-page').style.opacity = '0'; 
    setTimeout(() => { 
        document.getElementById('cover-page').style.display = 'none'; 
        document.getElementById('app-container').style.display = 'flex';
        switchMode('learn'); 
    }, 500); 
}

function switchMode(m, idx = 0) {
    cleanup();
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    if(document.getElementById('n-'+m)) document.getElementById('n-'+m).classList.add('active');
    document.querySelectorAll('.view, #result-screen').forEach(v => v.style.display = 'none');
    const target = document.getElementById('mode-'+m);
    if(target) target.style.display = (['list', 'match', 'wrong'].includes(m)) ? 'block' : 'flex';
    curIdx = idx; updateUI();
    if(m==='list') renderList();
    if(m==='match') resetMatchGame();
    if(m==='wrong') renderWrong();
}

function updateUI() {
    const item = vocabulary[curIdx];
    const isLearn = document.getElementById('mode-learn').style.display !== 'none';
    const isWrite = document.getElementById('mode-write').style.display !== 'none';
    const size = isLandscape ? 220 : 140;

    if(isLearn) {
        document.getElementById('s-pinyin').innerText = item.p;
        document.getElementById('s-mean').innerText = item.m;
        [...item.c].forEach((char) => {
            const wrap = createGrid(char, 'study', size);
            document.getElementById('s-grids').appendChild(wrap);
            const w = HanziWriter.create(wrap.querySelector('.writer-div'), char, { width: size, height: size, padding: 5, strokeColor: '#2f3542' });
            writers.push(w);
            wrap.onclick = () => { speak(char); w.animateCharacter(); };
        });
    }
    if(isWrite) {
        document.getElementById('w-mean').innerText = item.m;
        ansShow = false;
        [...item.c].forEach((char) => {
            const wrap = createGrid(char, 'write', size);
            document.getElementById('w-grids').appendChild(wrap);
            initCanvas(wrap.querySelector('canvas'), size);
        });
    }
    document.getElementById('p-char').innerText = item.c;
    document.getElementById('p-input').value = '';
}

function createGrid(char, mode, size) {
    const w = document.createElement('div'); w.className = 'tian-wrapper';
    w.style.width = size + 'px'; w.style.height = size + 'px';
    w.innerHTML = `<div class="tianzige"></div><div class="writer-div"></div>`;
    if(mode === 'write') w.innerHTML += `<canvas width="${size}" height="${size}"></canvas>`;
    return w;
}

function initCanvas(can, size) {
    const ctx = can.getContext('2d');
    let drawing = false; ctx.strokeStyle = "red"; ctx.lineWidth = 6; ctx.lineCap = "round";
    const getP = (e) => { 
        const r = can.getBoundingClientRect(); 
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    };
    can.onmousedown = can.ontouchstart = (e) => { e.preventDefault(); drawing = true; const p = getP(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    can.onmousemove = can.ontouchmove = (e) => { if(!drawing) return; const p = getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
    can.onmouseup = can.ontouchend = () => { drawing = false; };
}

function handleAnswer() {
    ansShow = !ansShow;
    const item = vocabulary[curIdx];
    const size = isLandscape ? 220 : 140;
    const grids = document.querySelectorAll('#w-grids .writer-div');
    grids.forEach((g, i) => {
        g.innerHTML = '';
        if(ansShow) HanziWriter.create(g, item.c[i], { width: size, height: size, padding: 5, strokeColor: '#bbb' });
    });
}

function resetMatchGame() {
    matchPool = [...vocabulary].sort(() => 0.5 - Math.random());
    matchedCount = 0; initMatchRound();
}

function initMatchRound() {
    const g = document.getElementById('match-grid'); g.innerHTML = ''; selectedMatch = [];
    document.getElementById('match-progress').innerText = `Progress: ${matchedCount}/100`;
    const roundItems = matchPool.slice(0, 3);
    if(!roundItems.length) { showFinal(); return; }
    let items = [];
    roundItems.forEach(v => { items.push({t: v.c, id: v.c}, {t: v.p, id: v.c}, {t: v.m, id: v.c}); });
    items.sort(() => 0.5 - Math.random()).forEach(it => {
        const d = document.createElement('div'); d.className = 'match-item'; d.innerText = it.t;
        d.style.cssText = "background:#fff; border:2px solid var(--primary); padding:10px; cursor:pointer; min-height:80px; display:flex; align-items:center; justify-content:center; border-radius:10px; font-weight:bold;";
        d.onclick = () => {
            if(d.classList.contains('selected') || d.style.visibility === 'hidden') return;
            d.style.background = 'var(--primary)'; d.style.color = 'white'; d.classList.add('selected'); 
            selectedMatch.push({el: d, id: it.id});
            if(selectedMatch.length === 3) {
                if(selectedMatch[0].id === selectedMatch[1].id && selectedMatch[1].id === selectedMatch[2].id) {
                    speak(selectedMatch[0].id);
                    selectedMatch.forEach(s => s.el.style.visibility = 'hidden');
                    if(![...g.children].some(child => child.style.visibility !== 'hidden')) {
                        matchedCount += roundItems.length; matchPool.splice(0, 3);
                        setTimeout(initMatchRound, 500);
                    }
                } else { 
                    const temp = [...selectedMatch];
                    setTimeout(() => temp.forEach(s => { s.el.style.background = '#fff'; s.el.style.color = '#000'; s.el.classList.remove('selected'); }), 300);
                }
                selectedMatch = [];
            }
        };
        g.appendChild(d);
    });
}

function checkPinyin() {
    const input = document.getElementById('p-input').value.toLowerCase().trim();
    const correct = vocabulary[curIdx].p.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if(input === correct) {
        document.getElementById('feedback-box').innerText='Correct! üëç';
        setTimeout(nextWord, 800);
    } else {
        document.getElementById('feedback-box').innerText='Try again! ‚ùå';
        if(!wrongAnswers.includes(vocabulary[curIdx])) wrongAnswers.push(vocabulary[curIdx]);
    }
}

function nextWord() { 
    if(curIdx >= vocabulary.length - 1) { showFinal(); return; }
    curIdx++; cleanup(); updateUI(); 
}

function showFinal() {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById('result-screen').style.display = 'block';
}

function renderList() {
    document.getElementById('list-view').innerHTML = vocabulary.map((v, i) => `
        <div class="list-card" onclick="switchMode('learn', ${i})">
            <span style="font-size:2rem;">${v.e}</span>
            <div style="flex:1"><b style="font-size:1.4rem;">${v.c}</b><br><span class="list-pinyin">${v.p}</span></div>
            <small style="color:#888;">${v.m}</small>
        </div>`).join('');
}

function renderWrong() {
    const container = document.getElementById('wrong-view');
    if(!wrongAnswers.length) { container.innerHTML = "<p style='text-align:center;'>No mistakes yet!</p>"; return; }
    container.innerHTML = wrongAnswers.map(v => {
        const idx = vocabulary.findIndex(it => it.c === v.c);
        return `<div class="list-card" onclick="switchMode('learn', ${idx})"><b style="font-size:1.4rem;">${v.c}</b><div style="margin-left:15px;"><span class="list-pinyin">${v.p}</span><br><small>${v.m}</small></div></div>`;
    }).join('');
}

function cleanup() { writers.forEach(w => { if(w && w.destroy) w.destroy(); }); writers = []; document.getElementById('s-grids').innerHTML = ''; document.getElementById('w-grids').innerHTML = ''; }
function speak(t) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'zh-CN'; m.rate = 0.8; window.speechSynthesis.speak(m); } }

window.onload = () => {
    // Ê∏≤ÊüìÊ∞¥Âç∞
    const wm = document.getElementById('wm-container');
    for(let i=0; i<150; i++) {
        const span = document.createElement('span');
        span.innerText = 'XUSFUNCHINESE';
        wm.appendChild(span);
    }
    // Ê∏≤ÊüìÂ∞ÅÈù¢ÊòüÁ©∫
    const container = document.getElementById('star-container');
    for(let i=0; i<30; i++) {
        let s = document.createElement('div'); s.className = 'star';
        s.style.setProperty('--angle', Math.random() * 360 + 'deg');
        s.style.animationDuration = Math.random() * 1 + 1 + 's';
        container.appendChild(s);
    }
};
</script>
</body>
</html>