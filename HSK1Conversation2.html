<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, landscape=yes">
    <title>HSK 1 Conversation 2 - XUSFUNCHINESE</title>
    <style>
        :root {
            --primary: #01579b; 
            --accent: #e1f5fe;  
            --gold: #fbc02d;
            --pinyin: #d0021b; 
            --night-sky: radial-gradient(circle at center, #001f3f 0%, #000510 100%);
        }
        
        body { 
            margin: 0; font-family: "Arial Black", "Segoe UI", Tahoma, sans-serif; 
            background: linear-gradient(135deg, #0277bd 0%, #002f6c 100%); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* é‡‘å…‰æµæ˜Ÿå°é¢ */
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: 5000; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: opacity 0.8s ease-out, visibility 0.8s; overflow: hidden;
        }
        .star {
            position: absolute; top: 50%; left: 50%; width: 2px; height: 2px;
            background: white; border-radius: 50%; box-shadow: 0 0 10px #fff;
            animation: shoot linear infinite;
        }
        @keyframes shoot {
            0% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(1000px); opacity: 0; width: 160px; }
        }
        .cover-content { text-align: center; z-index: 10; padding: 20px; }
        .cover-title { font-size: 8vw; color: var(--gold); line-height: 1.1; margin: 0; font-weight: 900; text-shadow: 0 0 30px rgba(251,192,45,0.8), 0 0 60px rgba(251,192,45,0.4); animation: glow 2s infinite alternate; }
        .cover-subtitle { font-size: 6vw; color: white; margin-top: 5px; font-weight: 900; }
        @keyframes glow { from { transform: scale(1); } to { transform: scale(1.05); } }

        header { 
            background: rgba(255,255,255,0.95); padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; 
        }
        .nav-btns button { 
            padding: 8px 12px; margin-right: 5px; border-radius: 20px; border: 2px solid var(--primary); 
            cursor: pointer; font-weight: bold; background: white; color: var(--primary);
        }
        .active-mode { background: var(--primary) !important; color: white !important; }

        main { flex: 1; display: flex; padding: 20px; gap: 15px; overflow: hidden; }
        #left-panel { flex: 1; background: rgba(255,255,255,0.95); border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid var(--accent); }
        #right-panel { flex: 1.6; background: rgba(255,255,255,0.95); border-radius: 30px; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; border: 4px solid var(--accent); position: relative; }

        ruby { ruby-align: center; font-size: 36px; margin: 0 4px; line-height: 2.2; font-weight: 600; }
        rt { font-size: 16px; color: var(--pinyin); font-weight: bold; }
        .eng-hint { display: block; font-size: 24px; color: #333; margin-top: 15px; border-top: 2px dashed #ccc; padding-top: 10px; font-style: italic; }
        #emoji-display { font-size: 110px; margin-bottom: 20px; }
        
        .option-btn { background: white; border: 2px solid var(--primary); padding: 15px; margin: 8px 0; border-radius: 15px; cursor: pointer; font-size: 20px; width: 100%; transition: 0.2s; text-align: left;}
        .option-btn:hover { background: var(--accent); }
        
        #scroll-view { display: none; width: 100%; overflow-y: auto; padding: 30px; background: white; border-radius: 30px; }
        .list-row { border-bottom: 1px solid var(--accent); padding: 15px; cursor: pointer; display: flex; align-items: center; }
        .list-row:hover { background: var(--accent); }
        
        .hidden { display: none !important; }
        #timer-display { font-size: 24px; color: #d32f2f; font-weight: bold; margin-right: 15px; }
        #score-val { color: var(--gold); }
    </style>
</head>
<body>

<div id="cover-page" onclick="enterApp()">
    <div id="star-container"></div>
    <div class="cover-content">
        <h1 class="cover-title">HSK 1</h1>
        <div class="cover-subtitle">Conversation 2</div>
        <div style="color:white; margin-top:20px; letter-spacing:3px; font-weight:bold;">CLICK TO START</div>
    </div>
</div>

<header>
    <div class="nav-btns">
        <button onclick="setMode('study')" id="btn-study">ğŸ“– Study</button>
        <button onclick="setMode('review')" id="btn-review">ğŸ”„ Review</button>
        <button onclick="setMode('quiz')" id="btn-quiz">âš¡ Rush (30s)</button>
        <button onclick="setMode('mistakes')" id="btn-mistakes">âŒ Mistake</button>
        <button onclick="setMode('list')" id="btn-list">ğŸ“œ Bank</button>
    </div>
    <div style="display: flex; align-items: center;">
        <span id="timer-display" class="hidden">00:30</span>
        <span style="font-weight: bold; color: var(--primary);">Score: <span id="score-val">0</span></span>
    </div>
</header>

<main>
    <div id="main-ui" style="display: flex; width: 100%; gap: 15px;">
        <div id="left-panel">
            <div id="emoji-display">âœ¨</div>
            <button onclick="speakQuestion()" style="padding: 15px 40px; border-radius: 50px; cursor: pointer; background: var(--primary); color: white; border: none; font-weight: bold; font-size: 20px;">ğŸ”Š Ask</button>
        </div>
        <div id="right-panel">
            <div id="display-area"></div>
            <div id="hint-box" style="margin-top:20px; padding:15px; background:#fffde7; border-left:8px solid var(--gold); border-radius:12px; cursor:pointer;" class="hidden" onclick="speakReply()"></div>
            <div id="interaction-area" style="margin-top: 15px;"></div>
        </div>
    </div>
    <div id="scroll-view"></div>
</main>

<script>
    // æ•°æ®åº“ï¼šHSK1 å‰©ä½™ç”Ÿè¯æ„æˆçš„ä¸€é—®ä¸€ç­” (ä¸é‡å¤ Conversation 1)
    const database = [
        ["ä½ æƒ³å–ä»€ä¹ˆï¼Ÿ", "nÇ xiÇng hÄ“ shÃ©n me ?", "What do you want to drink?", "ğŸµ", {cn: "æˆ‘æƒ³å–èŒ¶ã€‚", py: "wÇ’ xiÇng hÄ“ chÃ¡", en: "I want to drink tea."}],
        ["ä½ ä¼šè¯´æ±‰è¯­å—ï¼Ÿ", "nÇ huÃ¬ shuÅ hÃ n yÇ” ma ?", "Can you speak Chinese?", "ğŸ—£ï¸", {cn: "æˆ‘ä¼šè¯´ä¸€ç‚¹å„¿ã€‚", py: "wÇ’ huÃ¬ shuÅ yÃ¬ diÇnr", en: "I can speak a little bit."}],
        ["ä½ åœ¨çœ‹ä»€ä¹ˆï¼Ÿ", "nÇ zÃ i kÃ n shÃ©n me ?", "What are you watching?", "ğŸ‘ï¸", {cn: "æˆ‘åœ¨çœ‹ç”µå½±ã€‚", py: "wÇ’ zÃ i kÃ n diÃ n yÇng", en: "I am watching a movie."}],
        ["ä½ ä¼šè¯»è¿™ä¸ªå­—å—ï¼Ÿ", "nÇ huÃ¬ dÃº zhÃ¨ ge zÃ¬ ma ?", "Can you read this character?", "ğŸ“–", {cn: "æˆ‘ä¸è®¤è¯†è¿™ä¸ªå­—ã€‚", py: "wÇ’ bÃº rÃ¨n shi zhÃ¨ ge zÃ¬", en: "I don't know this character."}],
        ["ä½ ä¼šå†™æ±‰å­—å—ï¼Ÿ", "nÇ huÃ¬ xiÄ› hÃ n zÃ¬ ma ?", "Can you write Chinese characters?", "âœï¸", {cn: "æˆ‘ä¼šå†™ï¼Œå¤ªéš¾äº†ã€‚", py: "wÇ’ huÃ¬ xiÄ› , tÃ i nÃ¡n le", en: "I can write, but it's too hard."}],
        ["è¯·æ¥è¿™é‡Œåã€‚", "qÇng lÃ¡i zhÃ¨ lÇ zuÃ² .", "Please come and sit here.", "ğŸƒ", {cn: "è°¢è°¢ä½ ï¼Œå¤ªå¥½äº†ã€‚", py: "xiÃ¨ xie nÇ , tÃ i hÇo le", en: "Thank you, that's great."}],
        ["ä½ ä»€ä¹ˆæ—¶å€™å›å®¶ï¼Ÿ", "nÇ shÃ­ hou huÃ­ jiÄ ?", "When are you going home?", "ğŸ ", {cn: "ä¸‹åˆäº”ç‚¹å›ã€‚", py: "xiÃ  wÇ” wÇ” diÇn huÃ­", en: "Returning at 5 PM."}],
        ["æˆ‘ä»¬å»å•†åº—å§ï¼Ÿ", "wÇ’ men qÃ¹ shÄng diÃ n ba ?", "Shall we go to the shop?", "ğŸ›’", {cn: "å¥½ï¼Œæˆ‘æƒ³ä¹°æ°´æœã€‚", py: "hÇo , wÇ’ xiÇng mÇi shuÇ guÇ’", en: "OK, I want to buy fruit."}],
        ["ä½ æƒ³åƒä»€ä¹ˆèœï¼Ÿ", "nÇ xiÇng chÄ« shÃ©n me cÃ i ?", "What dish do you want to eat?", "ğŸ¥—", {cn: "æˆ‘æƒ³åƒä¸­å›½èœã€‚", py: "wÇ’ xiÇng chÄ« zhÅng guÃ³ cÃ i", en: "I want to eat Chinese food."}],
        ["ä½ åœ¨åšä»€ä¹ˆï¼Ÿ", "nÇ zÃ i zuÃ² shÃ©n me ?", "What are you doing?", "ğŸ› ï¸", {cn: "æˆ‘åœ¨åšé¥­ã€‚", py: "wÇ’ zÃ i zuÃ² fÃ n", en: "I am cooking."}],
        ["ä»–åœ¨å“ªå„¿å·¥ä½œï¼Ÿ", "tÄ zÃ i nÇ r gÅng zuÃ² ?", "Where does he work?", "ğŸ’¼", {cn: "ä»–åœ¨åŒ»é™¢å·¥ä½œã€‚", py: "tÄ zÃ i yÄ« yuÃ n gÅng zuÃ²", en: "He works in a hospital."}],
        ["æ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ", "mÃ­ng tiÄn huÃ¬ xiÃ  yÇ” ma ?", "Will it rain tomorrow?", "ğŸŒ§ï¸", {cn: "æ˜å¤©ä¸ä¸‹é›¨ã€‚", py: "mÃ­ng tiÄn bÃº xiÃ  yÇ”", en: "It won't rain tomorrow."}],
        ["è®¤è¯†ä½ å¾ˆé«˜å…´ã€‚", "rÃ¨n shi nÇ hÄ›n gÄo xÃ¬ng .", "Nice to meet you.", "ğŸ¤", {cn: "æˆ‘ä¹Ÿå¾ˆé«˜å…´ã€‚", py: "wÇ’ yÄ› hÄ›n gÄo xÃ¬ng", en: "I am happy too."}],
        ["ä½ çš„è¡£æœå¾ˆæ¼‚äº®ã€‚", "nÇ de yÄ« fu hÄ›n piÃ o liang .", "Your clothes are beautiful.", "ğŸ‘—", {cn: "è°¢è°¢ï¼Œå¤ªæ¼‚äº®äº†ã€‚", py: "xiÃ¨ xie , tÃ i piÃ o liang le", en: "Thank you, they are so pretty."}],
        ["è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ", "zhÃ¨ ge duÅ shao qiÃ¡n ?", "How much is this?", "ğŸ’°", {cn: "å…«åå—é’±ã€‚", py: "bÄ shÃ­ kuÃ i qiÃ¡n", en: "80 RMB."}],
        ["ä½ æ€ä¹ˆå»å­¦æ ¡ï¼Ÿ", "nÇ zÄ›n me qÃ¹ xuÃ© xiÃ o ?", "How do you go to school?", "ğŸš²", {cn: "æˆ‘åå‡ºç§Ÿè½¦å»ã€‚", py: "wÇ’ zuÃ² chÅ« zÅ« chÄ“ qÃ¹", en: "I go by taxi."}],
        ["å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ", "tiÄn qÃ¬ zÄ›n me yÃ ng ?", "How is the weather?", "ğŸŒ¤ï¸", {cn: "å¤©æ°”å¤ªçƒ­äº†ã€‚", py: "tiÄn qÃ¬ tÃ i rÃ¨ le", en: "The weather is too hot."}],
        ["ä»–æ˜¯è°ï¼Ÿ", "tÄ shÃ¬ shÃ©i ?", "Who is he?", "ğŸ‘¤", {cn: "ä»–æ˜¯æˆ‘çš„åŒ»ç”Ÿã€‚", py: "tÄ shÃ¬ wÇ’ de yÄ« shÄ“ng", en: "He is my doctor."}],
        ["ä¹¦åœ¨å“ªå„¿ï¼Ÿ", "shÅ« zÃ i nÇ r ?", "Where is the book?", "ğŸ“", {cn: "ä¹¦åœ¨æ¡Œå­ä¸Šã€‚", py: "shÅ« zÃ i zhuÅ zi shang", en: "The book is on the table."}],
        ["ä½ æƒ³çœ‹ç”µå½±å—ï¼Ÿ", "nÇ xiÇng kÃ n diÃ n yÇng ma ?", "Do you want to watch a movie?", "ğŸ¬", {cn: "ä¸æƒ³çœ‹ï¼Œå¤ªç´¯äº†ã€‚", py: "bÃ¹ xiÇng kÃ n , tÃ i lÃ¨i le", en: "No, I'm too tired."}],
        ["æˆ‘çœ‹ç”µè§†ï¼Œä½ å‘¢ï¼Ÿ", "wÇ’ kÃ n diÃ n shÃ¬ , nÇ ne ?", "I'm watching TV, and you?", "ğŸ“º", {cn: "æˆ‘å¬éŸ³ä¹ã€‚", py: "wÇ’ tÄ«ng yÄ«n yuÃ¨", en: "I'm listening to music."}],
        ["è¿™æ˜¯è°çš„ç”µè„‘ï¼Ÿ", "zhÃ¨ shÃ¬ shÃ©i de diÃ n nÇo ?", "Whose computer is this?", "ğŸ’»", {cn: "æˆ‘åŒå­¦çš„ã€‚", py: "wÇ’ tÃ³ng xuÃ© de", en: "My classmate's."}],
        ["ä½ åœ¨åŒ—äº¬ä½å¤šä¹…ï¼Ÿ", "nÇ zÃ i bÄ›i jÄ«ng zhÃ¹ duÅ jiÇ” ?", "How long stay in Beijing?", "ğŸ™ï¸", {cn: "ä½ä¸‰ä¸ªæœˆã€‚", py: "zhÃ¹ sÄn ge yuÃ¨", en: "Stay for 3 months."}],
        ["ä»–åœ¨å­¦ä¹ ä»€ä¹ˆï¼Ÿ", "tÄ zÃ i xuÃ© xÃ­ shÃ©n me ?", "What is he studying?", "ğŸ‡¨ğŸ‡³", {cn: "ä»–åœ¨å­¦ä¹ æ±‰è¯­ã€‚", py: "tÄ zÃ i xuÃ© xÃ­ hÃ n yÇ”", en: "He is studying Chinese."}],
        ["ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ", "nÇ jiÃ o shÃ©n me mÃ­ng zi ?", "What is your name?", "ğŸ“›", {cn: "æˆ‘å«ç‹æ–¹ã€‚", py: "wÇ’ jiÃ o wÃ¡ng fÄng", en: "My name is Wang Fang."}],
        ["ä½ æƒ³ä¹°ä»€ä¹ˆä¸œè¥¿ï¼Ÿ", "nÇ xiÇng mÇi shÃ©n me dÅng xi ?", "What things do you want to buy?", "ğŸ“¦", {cn: "æˆ‘æƒ³ä¹°äº›æ¯å­ã€‚", py: "wÇ’ xiÇng mÇi xiÄ“ bÄ“i zi", en: "I want to buy some cups."}],
        ["è¯·å¤šåƒç‚¹å„¿æ°´æœã€‚", "qÇng duÅ chÄ« diÇnr shuÇ guÇ’ .", "Please eat more fruit.", "ğŸ", {cn: "è°¢è°¢ï¼Œæˆ‘å¾ˆå–œæ¬¢ã€‚", py: "xiÃ¨ xie , wÇ’ hÄ›n xÇ huan", en: "Thanks, I like it a lot."}],
        ["ä½ æƒ³å–èŒ¶å—ï¼Ÿ", "nÇ xiÇng hÄ“ chÃ¡ ma ?", "Do you want to drink tea?", "ğŸµ", {cn: "å¥½çš„ï¼Œè¯·å–èŒ¶ã€‚", py: "hÇo de , qÇng hÄ“ chÃ¡", en: "OK, please drink tea."}],
        ["ä½ ä¼šåšé¥­å—ï¼Ÿ", "nÇ huÃ¬ zuÃ² fÃ n ma ?", "Can you cook?", "ğŸ‘¨â€ğŸ³", {cn: "æˆ‘ä¼šåšä¸­å›½èœã€‚", py: "wÇ’ huÃ¬ zuÃ² zhÅng guÃ³ cÃ i", en: "I can cook Chinese food."}],
        ["ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ", "jÄ«n tiÄn xÄ«ng qÄ« jÇ ?", "What day is today?", "ğŸ“…", {cn: "ä»Šå¤©æ˜ŸæœŸäº”ã€‚", py: "jÄ«n tiÄn xÄ«ng qÄ« wÇ”", en: "Today is Friday."}],
        ["ä½ çš„çŒ«åœ¨å“ªå„¿ï¼Ÿ", "nÇ de mÄo zÃ i nÇ r ?", "Where is your cat?", "ğŸ±", {cn: "åœ¨é‚£å„¿ï¼Œæ¤…å­ä¸‹é¢ã€‚", py: "zÃ i nÃ  r , yÇ zi xiÃ  mian", en: "Over there, under the chair."}],
        ["ä½ æœ‰å‡ ä¸ªå„¿å­ï¼Ÿ", "nÇ yÇ’u jÇ ge Ã©r zi ?", "How many sons do you have?", "ğŸ‘¦", {cn: "æˆ‘æœ‰ä¸€ä¸ªå„¿å­ã€‚", py: "wÇ’ yÇ’u yÃ­ ge Ã©r zi", en: "I have one son."}],
        ["ä½ å¥³å„¿å‡ å²äº†ï¼Ÿ", "nÇ nÇš Ã©r jÇ suÃ¬ le ?", "How old is your daughter?", "ğŸ‘§", {cn: "å¥¹å…­å²äº†ã€‚", py: "tÄ liÃ¹ suÃ¬ le", en: "She is six years old."}],
        ["ä»–åœ¨åŒ»é™¢ä½å‡ å¤©ï¼Ÿ", "tÄ zÃ i yÄ« yuÃ n zhÃ¹ jÇ tiÄn ?", "Days in hospital?", "ğŸ¥", {cn: "ä½ä¸ƒå¤©ã€‚", py: "zhÃ¹ qÄ« tiÄn", en: "Stay for 7 days."}],
        ["é‚£æ˜¯è°çš„ä¹¦ï¼Ÿ", "nÃ  shÃ¬ shÃ©i de shÅ« ?", "Whose book is that?", "ğŸ“š", {cn: "é‚£æ˜¯æˆ‘è€å¸ˆçš„ã€‚", py: "nÃ  shÃ¬ wÇ’ lÇo shÄ« de", en: "That is my teacher's."}],
        ["ä½ æƒ³å»å“ªå„¿ï¼Ÿ", "nÇ xiÇng qÃ¹ nÇ r ?", "Where do you want to go?", "âœˆï¸", {cn: "æˆ‘æƒ³å»åŒ—äº¬ã€‚", py: "wÇ’ xiÇng qÃ¹ bÄ›i jÄ«ng", en: "I want to go to Beijing."}],
        ["ä½ ä¼šå¼€è¿™è¾†è½¦å—ï¼Ÿ", "nÇ huÃ¬ kÄi zhÃ¨ liÃ ng chÄ“ ma ?", "Can you drive this car?", "ğŸš—", {cn: "æˆ‘ä¸å¼€ï¼Œæ²¡é’±ã€‚", py: "wÇ’ bÃ¹ kÄi , mÃ©i qiÃ¡n", en: "I don't drive, no money."}],
        ["æ¡Œå­ä¸Šæœ‰å‡ ä¸ªæ¯å­ï¼Ÿ", "zhuÅ zi shang yÇ’u jÇ ge bÄ“i zi ?", "How many cups on table?", "ğŸ¥›", {cn: "æœ‰ä¸‰ä¸ªæ¯å­ã€‚", py: "yÇ’u sÄn ge bÄ“i zi", en: "There are three cups."}],
        ["ä½ æ€ä¹ˆäº†ï¼Ÿ", "nÇ zÄ›n me le ?", "What happened to you?", "ğŸ¤’", {cn: "æˆ‘ä¸èˆ’æœï¼Œæƒ³ç¡è§‰ã€‚", py: "wÇ’ bÃ¹ shÅ« fu , xiÇng shuÃ¬ jiÃ o", en: "I'm not well, want to sleep."}],
        ["è¯·åï¼Œå–ç‚¹å„¿æ°´ã€‚", "qÇng zuÃ² , hÄ“ diÇnr shuÇ .", "Sit and drink some water.", "ğŸª‘", {cn: "è°¢è°¢ä½ ï¼Œä¸å®¢æ°”ã€‚", py: "xiÃ¨ xie nÇ , bÃº kÃ¨ qi", en: "Thank you, you're welcome."}],
        ["ä½ ä¼šå†™åå­—å—ï¼Ÿ", "nÇ huÃ¬ xiÄ› mÃ­ng zi ma ?", "Can you write your name?", "ğŸ“", {cn: "æˆ‘ä¼šå†™ï¼Œä½ çœ‹ã€‚", py: "wÇ’ huÃ¬ xiÄ› , nÇ kÃ n", en: "I can write, look."}],
        ["æ˜¨å¤©ä½ å»å“ªå„¿äº†ï¼Ÿ", "zuÃ³ tiÄn nÇ qÃ¹ nÇ r le ?", "Where did you go yesterday?", "ğŸ”™", {cn: "æˆ‘å›å­¦æ ¡äº†ã€‚", py: "wÇ’ huÃ­ xuÃ© xiÃ o le", en: "I went back to school."}],
        ["ä½ çš„æœ‹å‹æ˜¯è°ï¼Ÿ", "nÇ de pÃ©ng you shÃ¬ shÃ©i ?", "Who is your friend?", "ğŸ‘«", {cn: "ä»–å«ææ˜ã€‚", py: "tÄ jiÃ o lÇ mÃ­ng", en: "He is called Li Ming."}],
        ["é‚£æ˜¯ä½ çš„ç‹—å—ï¼Ÿ", "nÃ  shÃ¬ nÇ de gÇ’u ma ?", "Is that your dog?", "ğŸ¶", {cn: "ä¸æ˜¯ï¼Œæˆ‘åŒå­¦çš„ã€‚", py: "bÃº shÃ¬ , wÇ’ tÃ³ng xuÃ© de", en: "No, my classmate's."}],
        ["è¿™é‡Œæœ‰å¤šå°‘äººï¼Ÿ", "zhÃ¨ lÇ yÇ’u duÅ shao rÃ©n ?", "How many people here?", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦", {cn: "æœ‰åäºŒä¸ªäººã€‚", py: "yÇ’u shÃ­ Ã¨r ge rÃ©n", en: "There are 12 people."}],
        ["ä»–ä»€ä¹ˆæ—¶å€™æ¥ï¼Ÿ", "tÄ shÃ­ hou lÃ¡i ?", "When is he coming?", "ğŸ•˜", {cn: "ä¹ç‚¹æ¥ã€‚", py: "jiÇ” diÇn lÃ¡i", en: "Coming at 9 o'clock."}],
        ["ä½ æƒ³å–ç‚¹å„¿ä»€ä¹ˆï¼Ÿ", "nÇ xiÇng hÄ“ diÇnr shÃ©n me ?", "What would you like to drink?", "ğŸ¹", {cn: "è¯·å–ç‚¹å„¿å†·æ°´ã€‚", py: "qÇng hÄ“ diÇnr lÄ›ng shuÇ", en: "Please drink some cold water."}],
        ["æ±‰è¯­éš¾ä¸éš¾ï¼Ÿ", "hÃ n yÇ” nÃ¡n bÃ¹ nÃ¡n ?", "Is Chinese hard?", "ğŸˆµ", {cn: "ä¸éš¾ï¼Œå¾ˆå¥½å¬ã€‚", py: "bÃ¹ nÃ¡n , hÄ›n hÇo tÄ«ng", en: "Not hard, sounds good."}],
        ["ä»–åœ¨å®¶åšä»€ä¹ˆï¼Ÿ", "tÄ zÃ i jiÄ zuÃ² shÃ©n me ?", "What is he doing at home?", "ğŸ›‹ï¸", {cn: "ä»–åœ¨å¬éŸ³ä¹ã€‚", py: "tÄ zÃ i jiÄ tÄ«ng yÄ«n yuÃ¨", en: "He is listening to music."}],
        ["è°¢è°¢ï¼Œå†è§ï¼", "xiÃ¨ xie , zÃ i jiÃ n !", "Thanks, goodbye!", "ğŸ‘‹", {cn: "ä¸å®¢æ°”ï¼Œå†è§ã€‚", py: "bÃº kÃ¨ qi , zÃ i jiÃ n", en: "You're welcome, bye."}]
    ];

    let currentMode = 'study', currentIndex = 0, score = 0, timer = null, timeLeft = 30;
    let mistakes = []; 

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playEffect(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if(type === 'win') {
            osc.frequency.setValueAtTime(987, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1318, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(110, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        }
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function initStars() {
        const container = document.getElementById('star-container');
        for(let i=0; i<80; i++) {
            let s = document.createElement('div'); s.className = 'star';
            s.style.setProperty('--angle', Math.random() * 360 + 'deg');
            s.style.animationDuration = Math.random() * 1.5 + 0.8 + 's';
            container.appendChild(s);
        }
    }

    function enterApp() {
        document.getElementById('cover-page').style.opacity = '0';
        setTimeout(() => { document.getElementById('cover-page').style.visibility = 'hidden'; }, 800);
        setMode('study');
    }

    function speakText(text, callback = null) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(text);
        m.lang = 'zh-CN'; m.rate = 0.8;
        if (callback) m.onend = callback;
        window.speechSynthesis.speak(m);
    }

    function speakQuestion() {
        let activeData = (currentMode === 'mistakes') ? mistakes[currentIndex] : database[currentIndex];
        speakText(activeData[0]);
    }

    function speakReply() {
        let activeData = (currentMode === 'mistakes') ? mistakes[currentIndex] : database[currentIndex];
        speakText(activeData[4].cn);
    }

    function setMode(m, jumpIndex = 0) {
        currentMode = m; 
        currentIndex = jumpIndex; 
        clearInterval(timer);
        document.querySelectorAll('.nav-btns button').forEach(b => b.classList.remove('active-mode'));
        if(document.getElementById('btn-'+m)) document.getElementById('btn-'+m).classList.add('active-mode');
        document.getElementById('timer-display').classList.add('hidden');
        
        if (m === 'quiz') {
            timeLeft = 30; score = 0;
            document.getElementById('score-val').innerText = "0";
            document.getElementById('timer-display').classList.remove('hidden');
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                if (timeLeft <= 0) { 
                    clearInterval(timer); 
                    const praises = ["Excellent!", "Great job!", "You are amazing!"];
                    speakText(praises[Math.floor(Math.random()*praises.length)]);
                    alert("Rush End! Your Score: " + score); 
                    setMode('study'); 
                }
            }, 1000);
        }

        if(m === 'list') {
            document.getElementById('main-ui').classList.add('hidden');
            document.getElementById('scroll-view').style.display = 'block';
            renderList();
        } else {
            document.getElementById('main-ui').classList.remove('hidden');
            document.getElementById('scroll-view').style.display = 'none';
            render();
        }
    }

    function generateRubyHtml(text, pinyinStr) {
        const chars = text.split(''); const pys = pinyinStr.split(' ');
        let html = ""; let pyIdx = 0;
        chars.forEach(c => {
            if(/[\u4e00-\u9fa5]/.test(c)) {
                html += `<ruby>${c}<rt>${pys[pyIdx] || ''}</rt></ruby>`; pyIdx++;
            } else if (![' ', '!', '?', 'ï¼', 'ï¼Ÿ', '.', 'ã€‚', ','].includes(c)) {
                html += c; pyIdx++;
            } else html += c;
        });
        return html;
    }

    function render() {
        const display = document.getElementById('display-area');
        const interaction = document.getElementById('interaction-area');
        const hint = document.getElementById('hint-box');
        display.innerHTML = ""; interaction.innerHTML = ""; hint.classList.add('hidden');

        if (currentMode === 'mistakes' && mistakes.length === 0) {
            display.innerHTML = "<h2 style='text-align:center; color:#666;'>No mistakes yet! Keep going!</h2>";
            return;
        }

        let activeData = (currentMode === 'mistakes') ? mistakes[currentIndex] : database[currentIndex];
        document.getElementById('emoji-display').innerText = activeData[3];

        if (currentMode === 'study') {
            display.innerHTML = generateRubyHtml(activeData[0], activeData[1]) + `<span class="eng-hint">${activeData[2]}</span>`;
            hint.innerHTML = `<div style="font-size:26px;">${generateRubyHtml(activeData[4].cn, activeData[4].py)}</div><div style="font-style:italic; color:#666; margin-top:10px;">${activeData[4].en}</div><div style="font-size:12px; color:#999; margin-top:5px; text-align:right;">ğŸ”Š Click to speak</div>`;
            hint.classList.remove('hidden');
            interaction.innerHTML = `<button class="option-btn" onclick="nextCard()" style="background:var(--primary); color:white; text-align:center;">Next Sentence â†’</button>`;
            speakText(activeData[0]); 
        } 
        else if (currentMode === 'review') {
            display.innerHTML = `<h1 style="font-size:48px; cursor:pointer; text-align:center;" onclick="revealReview()">${activeData[0]}</h1><p style="text-align:center; color:#888;">(Click question to see reply)</p>`;
            interaction.innerHTML = `<button class="option-btn" onclick="nextCard()" style="background:#eee; text-align:center;">Skip â†’</button>`;
        }
        else {
            // Quiz (Rush) or Mistakes Mode
            display.innerHTML = `<h2 style="font-size:32px; text-align:center; color:var(--primary); margin-bottom:10px;">Q: ${activeData[0]}</h2><p style="text-align:center; color:#666;">Choose the correct reply:</p>`;
            
            let choices = [activeData[4].cn];
            while(choices.length < 4) {
                let r = database[Math.floor(Math.random()*database.length)];
                if(!choices.includes(r[4].cn)) choices.push(r[4].cn);
            }
            choices.sort(() => Math.random() - 0.5);

            choices.forEach(c => {
                const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = c;
                b.onclick = () => {
                    if(c === activeData[4].cn) {
                        playEffect('win'); speakReply();
                        if (currentMode === 'quiz') { score += 10; document.getElementById('score-val').innerText = score; }
                        b.style.background = "#4caf50"; b.style.color = "white"; 
                        if (currentMode === 'mistakes') { mistakes.splice(currentIndex, 1); currentIndex--; }
                        setTimeout(nextCard, 600);
                    } else { 
                        playEffect('fail');
                        b.style.background = "#f44336"; b.style.color = "white";
                        if (!mistakes.some(m => m[0] === activeData[0])) mistakes.push(activeData);
                    }
                };
                interaction.appendChild(b);
            });
        }
    }

    function revealReview() {
        let activeData = (currentMode === 'mistakes') ? mistakes[currentIndex] : database[currentIndex];
        const hint = document.getElementById('hint-box');
        hint.innerHTML = `<div style="font-size:26px;">${generateRubyHtml(activeData[4].cn, activeData[4].py)}</div><div style="font-style:italic; color:#666;">${activeData[4].en}</div>`;
        hint.classList.remove('hidden');
        speakReply();
        document.getElementById('interaction-area').innerHTML = `<button class="option-btn" onclick="nextCard()" style="background:var(--primary); color:white; text-align:center;">Next â†’</button>`;
    }

    function nextCard() {
        let activeList = (currentMode === 'mistakes') ? mistakes : database;
        currentIndex++;
        if (currentIndex >= activeList.length) {
            currentIndex = 0;
            if (currentMode !== 'quiz') alert("End of list!");
        }
        render();
    }

    function renderList() {
        const view = document.getElementById('scroll-view');
        view.innerHTML = "<h2>ğŸ“œ HSK 1 Conversation Bank (II)</h2><p style='color:#666;'>Click any sentence to study!</p>";
        database.forEach((it, idx) => {
            const r = document.createElement('div'); r.className = 'list-row';
            r.innerHTML = `<div style="min-width:40px; color:#999; font-weight:bold;">${idx+1}.</div>
                <div style="font-size:32px; margin-right:15px;">${it[3]}</div>
                <div style="flex:1;"><b>Q: ${it[0]}</b><br><small style="color:var(--primary);">A: ${it[4].cn}</small><br><small style="color:#888;">${it[4].en}</small></div>`;
            r.onclick = () => { setMode('study', idx); };
            view.appendChild(r);
        });
    }

    window.onload = () => { initStars(); };
</script>
</body>
</html>