<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>XUSFUNCHINESE - HSK2 Writing Mode üèÆ</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        :root { 
            --pinyin-red: #ff0000; /* Êõ¥Âä†ÈÜíÁõÆÁöÑÁ∫¢Ëâ≤ */
            --paper: rgba(255, 255, 255, 0.95); 
            --gold: #fbc02d; 
            --accent: #218c74; 
            --primary: #01579b;
            --night-sky: radial-gradient(circle at center, #1a237e 0%, #000510 100%);
        }
        body { 
            margin: 0; font-family: "Arial Black", sans-serif; 
            background: linear-gradient(135deg, #1565c0 0%, #002f6c 100%); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: 5000; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: opacity 0.5s;
        }
        .star {
            position: absolute; top: 50%; left: 50%; width: 2px; height: 2px;
            background: white; border-radius: 50%; animation: shoot linear infinite;
        }
        @keyframes shoot {
            0% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(var(--angle)) translateX(1000px); opacity: 0; width: 100px; }
        }
        #app-container { 
            width: 96vw; height: 92vh; background: var(--paper); 
            display: flex; margin: auto; border: 6px double var(--primary); 
            border-radius: 20px; overflow: hidden; z-index: 10;
        }
        .sidebar { width: 160px; background: rgba(255,255,255,0.9); border-right: 2px solid var(--primary); display: flex; flex-direction: column; }
        .sidebar button { padding: 12px; border: none; background: none; font-size: 0.9rem; font-weight: bold; color: var(--primary); cursor: pointer; border-bottom: 1px solid #eee; text-align: left; }
        .sidebar button.active { background: var(--primary); color: white; }
        .sidebar-watermark { margin-top: auto; padding-bottom: 10px; text-align: center; font-size: 10px; color: var(--primary); opacity: 0.5; font-weight: bold; }
        .content { flex: 1; padding: 10px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; position: relative; }
        #feedback-box { font-size: 2rem; height: 1.2em; color: var(--accent); font-weight: bold; }
        .grid-flex { display: flex; gap: 10px; margin: 5px 0; flex-wrap: wrap; justify-content: center; }
        .tian-wrapper { position: relative; width: 160px; height: 160px; background: #fff; border: 2px solid #8b4513; }
        .tianzige { position: absolute; width: 100%; height: 100%; pointer-events: none; opacity: 0.2; background: linear-gradient(45deg, transparent 49%, red 50%, transparent 51%), linear-gradient(-45deg, transparent 49%, red 50%, transparent 51%), linear-gradient(to right, transparent 49%, red 50%, transparent 51%), linear-gradient(to bottom, transparent 49%, red 50% ,transparent 51%); }
        .writer-div { position: absolute; top:0; left:0; width:100%; height:100%; }
        canvas { position: absolute; top:0; left:0; z-index: 5; touch-action: none; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; background: var(--primary); color: #fff; font-weight: bold; margin: 5px; }
        #match-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 95%; }
        .match-item { background: #fff; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.9rem; min-height: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold;}
        .match-item.selected { background: var(--primary); color: white; }
        .match-item.hidden { visibility: hidden; }
        #list-view, #wrong-view { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 95%; }
        .list-card { background:#fff; padding:10px; border-radius:8px; border:1px solid #ddd; display:flex; align-items:center; gap:10px; cursor:pointer; }
        #result-screen { text-align: center; padding: 20px; display: none; }
    </style>
</head>
<body>

<div id="cover-page" onclick="enterApp()">
    <div id="star-container"></div>
    <div style="text-align:center; color:white; z-index:10;">
        <h1 style="font-size:5vw; margin:0;">150 HANZI</h1>
        <h2 style="color:var(--gold); font-size:6vw; margin:0;">HSK 2</h2>
        <p style="letter-spacing:2px; margin-top:20px;">CLICK TO START</p>
    </div>
</div>

<div id="app-container">
    <div class="sidebar">
        <button id="n-learn" class="active" onclick="switchMode('learn')">üìñ Study</button>
        <button id="n-write" onclick="switchMode('write')">‚úçÔ∏è Dictation</button>
        <button id="n-match" onclick="switchMode('match')">üß© Matching</button>
        <button id="n-pinyin" onclick="switchMode('pinyin')">‚å®Ô∏è Pinyin</button>
        <button id="n-list" onclick="switchMode('list')">üìú Word List</button>
        <button id="n-wrong" onclick="switchMode('wrong')" style="color:#d32f2f;">‚ùå Mistake</button>
        <div class="sidebar-watermark">¬© XUSFUNCHINESE</div>
    </div>
    <div class="content">
        <div id="feedback-box"></div>
        <div id="mode-learn" class="view" style="display:flex; flex-direction:column; align-items:center;">
            <div id="s-pinyin" style="color:var(--pinyin-red); font-size:2rem; font-weight:bold;"></div>
            <div id="s-mean" style="font-size:1.2rem; color:#444;"></div>
            <div id="s-grids" class="grid-flex"></div>
            <button class="btn" onclick="nextWord()">Next</button>
        </div>
        <div id="mode-write" class="view" style="display:none; flex-direction:column; align-items:center;">
            <div id="w-mean" style="font-size:1.8rem; font-weight:bold; color:var(--pinyin-red);"></div>
            <div id="w-grids" class="grid-flex"></div>
            <div>
                <button id="ans-btn" class="btn" style="background:var(--gold); color:var(--primary)" onclick="handleAnswer()">Show Answer</button>
                <button class="btn" onclick="nextWord()">Next</button>
            </div>
        </div>
        <div id="mode-match" class="view" style="display:none; width:100%">
            <div id="match-grid"></div>
            <div style="text-align:center; margin-top:10px;">
                <div id="match-progress" style="font-weight:bold; color:var(--primary);"></div>
                <button class="btn" onclick="resetMatchGame()">Reset</button>
            </div>
        </div>
        <div id="mode-pinyin" class="view" style="display:none; flex-direction:column; align-items:center;">
            <h1 id="p-char" style="font-size:5rem; margin:10px;"></h1>
            <input type="text" id="p-input" placeholder="pinyin" style="padding:10px; font-size:1.5rem; text-align:center; width:200px; border:2px solid var(--primary); border-radius:10px;">
            <button class="btn" style="margin-top:15px;" onclick="checkPinyin()">Check</button>
        </div>
        <div id="mode-list" class="view" style="display:none; width:100%"><div id="list-view"></div></div>
        <div id="mode-wrong" class="view" style="display:none; width:100%"><div id="wrong-view"></div></div>
        <div id="result-screen">
            <h2 id="result-text" style="color:var(--primary)"></h2>
            <p>Please subscribe to "Xu's Fun Chinese" on Youtube!</p>
            <button class="btn" onclick="switchMode('learn')">Restart</button>
        </div>
    </div>
</div>

<script>
const vocabulary = [
    {c:"Âêß", p:"ba", m:"(modal particle)", e:"üí¨"}, {c:"ÁôΩ", p:"b√°i", m:"white", e:"‚ö™"}, {c:"Áôæ", p:"b«éi", m:"hundred", e:"üíØ"}, {c:"Â∏ÆÂä©", p:"bƒÅngzh√π", m:"to help", e:"ü§ù"}, {c:"Êä•Á∫∏", p:"b√†ozh«ê", m:"newspaper", e:"üì∞"},
    {c:"ÊØî", p:"b«ê", m:"than / compare", e:"‚öñÔ∏è"}, {c:"Âà´", p:"bi√©", m:"don't", e:"üö´"}, {c:"Èïø", p:"ch√°ng", m:"long", e:"üìè"}, {c:"Âî±Ê≠å", p:"ch√†nggƒì", m:"to sing", e:"üé§"}, {c:"Âá∫", p:"ch≈´", m:"to go out", e:"üö™"},
    {c:"Á©ø", p:"chuƒÅn", m:"to wear", e:"üëï"}, {c:"Ê¨°", p:"c√¨", m:"times / frequency", e:"üî¢"}, {c:"‰ªé", p:"c√≥ng", m:"from", e:"‚û°Ô∏è"}, {c:"Èîô", p:"cu√≤", m:"wrong", e:"‚ùå"}, {c:"ÊâìÁØÆÁêÉ", p:"d«é l√°nqi√∫", m:"play basketball", e:"üèÄ"},
    {c:"Â§ßÂÆ∂", p:"d√†jiƒÅ", m:"everyone", e:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶"}, {c:"Âà∞", p:"d√†o", m:"to arrive", e:"üìç"}, {c:"Âæó", p:"de", m:"(particle)", e:"üß©"}, {c:"Á≠â", p:"dƒõng", m:"to wait", e:"‚è≥"}, {c:"ÂºüÂºü", p:"d√¨di", m:"younger brother", e:"üë¶"},
    {c:"Á¨¨‰∏Ä", p:"d√¨-yƒ´", m:"first", e:"ü•á"}, {c:"ÊáÇ", p:"d«íng", m:"to understand", e:"üí°"}, {c:"ÂØπ", p:"du√¨", m:"correct / right", e:"‚úÖ"}, {c:"ÂØπ", p:"du√¨", m:"towards", e:"üéØ"}, {c:"ÊàøÈó¥", p:"f√°ngjiƒÅn", m:"room", e:"üõå"},
    {c:"ÈùûÂ∏∏", p:"fƒìich√°ng", m:"extremely", e:"üî•"}, {c:"ÊúçÂä°Âëò", p:"f√∫w√πyu√°n", m:"waiter/waitress", e:"üíÅ"}, {c:"È´ò", p:"gƒÅo", m:"high / tall", e:"ü¶í"}, {c:"ÂëäËØâ", p:"g√†osu", m:"to tell", e:"üó£Ô∏è"}, {c:"Âì•Âì•", p:"gƒìge", m:"older brother", e:"üë±"},
    {c:"Áªô", p:"gƒõi", m:"to give", e:"üéÅ"}, {c:"ÂÖ¨ÂÖ±Ê±ΩËΩ¶", p:"g≈çngg√≤ng q√¨chƒì", m:"bus", e:"üöå"}, {c:"ÂÖ¨Âè∏", p:"g≈çngsƒ´", m:"company", e:"üè¢"}, {c:"Áãó", p:"g«íu", m:"dog", e:"üê∂"}, {c:"Ë¥µ", p:"gu√¨", m:"expensive", e:"üíé"},
    {c:"Ëøá", p:"gu√≤", m:"(past tense particle)", e:"üïí"}, {c:"Ëøò", p:"h√°i", m:"still / also", e:"‚ûï"}, {c:"Â≠©Â≠ê", p:"h√°izi", m:"child", e:"üë∂"}, {c:"Â•ΩÂêÉ", p:"h«éochƒ´", m:"delicious", e:"üòã"}, {c:"Èªë", p:"hƒìi", m:"black", e:"‚ö´"},
    {c:"Á∫¢", p:"h√≥ng", m:"red", e:"üî¥"}, {c:"Ê¨¢Ëøé", p:"huƒÅny√≠ng", m:"welcome", e:"üôå"}, {c:"ÂõûÁ≠î", p:"hu√≠d√°", m:"to answer", e:"üôã"}, {c:"ÁÅ´ËΩ¶Á´ô", p:"hu«íchƒìzh√†n", m:"train station", e:"üöâ"}, {c:"Êú∫Âú∫", p:"jƒ´ch«éng", m:"airport", e:"‚úàÔ∏è"},
    {c:"È∏°Ëõã", p:"jƒ´d√†n", m:"egg", e:"ü•ö"}, {c:"‰ª∂", p:"ji√†n", m:"(measure word for clothes)", e:"üß•"}, {c:"ÊïôÂÆ§", p:"ji√†osh√¨", m:"classroom", e:"üè´"}, {c:"ÂßêÂßê", p:"jiƒõjiƒõ", m:"older sister", e:"üëß"}, {c:"‰ªãÁªç", p:"ji√®sh√†o", m:"to introduce", e:"ü§ù"},
    {c:"Ëøõ", p:"j√¨n", m:"to enter", e:"üö∂"}, {c:"Ëøë", p:"j√¨n", m:"near / close", e:"üë£"}, {c:"Â∞±", p:"ji√π", m:"at once / then", e:"‚ö°"}, {c:"ËßâÂæó", p:"ju√©de", m:"to feel / think", e:"ü§î"}, {c:"ÂíñÂï°", p:"kƒÅfƒìi", m:"coffee", e:"‚òï"},
    {c:"ÂºÄÂßã", p:"kƒÅish«ê", m:"to start", e:"üé¨"}, {c:"ËÄÉËØï", p:"k«éosh√¨", m:"exam", e:"üìù"}, {c:"ÂèØËÉΩ", p:"kƒõn√©ng", m:"possible / maybe", e:"‚ùì"}, {c:"ÂèØ‰ª•", p:"kƒõy«ê", m:"can / may", e:"üÜó"}, {c:"ËØæ", p:"k√®", m:"lesson / class", e:"üìö"},
    {c:"Âø´", p:"ku√†i", m:"fast / quick", e:"üèÉ"}, {c:"Âø´‰πê", p:"ku√†il√®", m:"happy", e:"üòä"}, {c:"Á¥Ø", p:"l√®i", m:"tired", e:"üò´"}, {c:"Á¶ª", p:"l√≠", m:"away from", e:"üìè"}, {c:"‰∏§", p:"li«éng", m:"two", e:"‚úåÔ∏è"},
    {c:"Ë∑Ø", p:"l√π", m:"road / path", e:"üõ£Ô∏è"}, {c:"ÊóÖÊ∏∏", p:"l«öy√≥u", m:"to travel", e:"üß≥"}, {c:"Âçñ", p:"m√†i", m:"to sell", e:"üí∞"}, {c:"ÊÖ¢", p:"m√†n", m:"slow", e:"üê¢"}, {c:"Âøô", p:"m√°ng", m:"busy", e:"üèÉ‚Äç‚ôÇÔ∏èüí®"},
    {c:"ÊØè", p:"mƒõi", m:"every / each", e:"üóìÔ∏è"}, {c:"Â¶πÂ¶π", p:"m√®imei", m:"younger sister", e:"üëß"}, {c:"Èó®", p:"m√©n", m:"door", e:"üö™"}, {c:"Èù¢Êù°", p:"mi√†nti√°o", m:"noodles", e:"üçú"}, {c:"Áî∑", p:"n√°n", m:"male", e:"üë®"},
    {c:"ÊÇ®", p:"n√≠n", m:"you (polite)", e:"üôè"}, {c:"ÁâõÂ•∂", p:"ni√∫n«éi", m:"milk", e:"ü•õ"}, {c:"Â•≥", p:"n«ö", m:"female", e:"üë©"}, {c:"ÊóÅËæπ", p:"p√°ngbiƒÅn", m:"beside / side", e:"üëà"}, {c:"Ë∑ëÊ≠•", p:"p«éob√π", m:"to run", e:"üèÉ"},
    {c:"‰æøÂÆú", p:"pi√°nyi", m:"cheap", e:"üè∑Ô∏è"}, {c:"Á•®", p:"pi√†o", m:"ticket", e:"üéüÔ∏è"}, {c:"Â¶ªÂ≠ê", p:"qƒ´zi", m:"wife", e:"üíç"}, {c:"Ëµ∑Â∫ä", p:"q«êchu√°ng", m:"get up", e:"‚òÄÔ∏è"}, {c:"ÂçÉ", p:"qiƒÅn", m:"thousand", e:"üî¢"},
    {c:"ÈìÖÁ¨î", p:"qiƒÅnb«ê", m:"pencil", e:"‚úèÔ∏è"}, {c:"Êô¥", p:"q√≠ng", m:"sunny", e:"‚òÄÔ∏è"}, {c:"ÂéªÂπ¥", p:"q√πni√°n", m:"last year", e:"‚è™"}, {c:"ËÆ©", p:"r√†ng", m:"to let / allow", e:"üÜó"}, {c:"Êó•", p:"r√¨", m:"day / sun", e:"‚òÄÔ∏è"},
    {c:"‰∏äÁè≠", p:"sh√†ngbƒÅn", m:"go to work", e:"üíº"}, {c:"Ë∫´‰Ωì", p:"shƒìnt«ê", m:"body / health", e:"üí™"}, {c:"ÁîüÁóÖ", p:"shƒìngb√¨ng", m:"to get sick", e:"ü§í"}, {c:"ÁîüÊó•", p:"shƒìngr√¨", m:"birthday", e:"üéÇ"}, {c:"Êó∂Èó¥", p:"sh√≠jiƒÅn", m:"time", e:"‚åö"},
    {c:"‰∫ãÊÉÖ", p:"sh√¨qing", m:"matter / thing", e:"üìã"}, {c:"ÊâãË°®", p:"sh«íubi«éo", m:"watch", e:"‚åö"}, {c:"ÊâãÊú∫", p:"sh«íujƒ´", m:"phone", e:"üì±"}, {c:"ËØ¥ËØù", p:"shu≈çhu√†", m:"to speak", e:"üó£Ô∏è"}, {c:"ÈÄÅ", p:"s√≤ng", m:"to deliver/give", e:"üéÅ"},
    {c:"ËôΩÁÑ∂", p:"suƒ´r√°n", m:"although", e:"üîÑ"}, {c:"‰ΩÜÊòØ", p:"d√†nsh√¨", m:"but", e:"‚úã"}, {c:"ÂÆÉ", p:"tƒÅ", m:"it", e:"üê∂"}, {c:"Ë∏¢Ë∂≥ÁêÉ", p:"tƒ´ z√∫qi√∫", m:"play soccer", e:"‚öΩ"}, {c:"È¢ò", p:"t√≠", m:"question / topic", e:"‚ùì"},
    {c:"Ë∑≥Ëàû", p:"ti√†ow«î", m:"to dance", e:"üíÉ"}, {c:"Â§ñ", p:"w√†i", m:"outside", e:"üåç"}, {c:"ÂÆå", p:"w√°n", m:"to finish", e:"üèÅ"}, {c:"Áé©", p:"w√°n", m:"to play", e:"üéÆ"}, {c:"Êôö‰∏ä", p:"w«énshang", m:"evening", e:"üåô"},
    {c:"‰∏∫‰ªÄ‰πà", p:"w√®ish√©nme", m:"why", e:"‚ùî"}, {c:"ÈóÆ", p:"w√®n", m:"to ask", e:"‚ùì"}, {c:"ÈóÆÈ¢ò", p:"w√®nt√≠", m:"problem/question", e:"ü§î"}, {c:"Ë•øÁìú", p:"xƒ´guƒÅ", m:"watermelon", e:"üçâ"}, {c:"Â∏åÊúõ", p:"xƒ´w√†ng", m:"to hope", e:"üåü"},
    {c:"Ê¥ó", p:"x«ê", m:"to wash", e:"üßº"}, {c:"Â∞èÊó∂", p:"xi«éosh√≠", m:"hour", e:"‚åõ"}, {c:"Á¨ë", p:"xi√†o", m:"to laugh", e:"üòÑ"}, {c:"Êñ∞", p:"xƒ´n", m:"new", e:"‚ú®"}, {c:"Âßì", p:"x√¨ng", m:"surname", e:"üìõ"},
    {c:"‰ºëÊÅØ", p:"xi≈´xi", m:"to rest", e:"üõå"}, {c:"Èõ™", p:"xuƒõ", m:"snow", e:"‚ùÑÔ∏è"}, {c:"È¢úËâ≤", p:"y√°ns√®", m:"color", e:"üé®"}, {c:"ÁúºÁùõ", p:"y«énjing", m:"eye", e:"üëÄ"}, {c:"ÁæäËÇâ", p:"y√°ngr√≤u", m:"mutton", e:"üçñ"},
    {c:"ËçØ", p:"y√†o", m:"medicine", e:"üíä"}, {c:"Ë¶Å", p:"y√†o", m:"to want", e:"üñêÔ∏è"}, {c:"‰πü", p:"yƒõ", m:"also", e:"üîÅ"}, {c:"‰∏ÄËµ∑", p:"y√¨q«ê", m:"together", e:"üßë‚Äçü§ù‚Äçüßë"}, {c:"‰∏Ä‰∏ã", p:"y√≠xi√†", m:"a bit", e:"‚è≥"},
    {c:"Â∑≤Áªè", p:"y«êjƒ´ng", m:"already", e:"‚úÖ"}, {c:"ÊÑèÊÄù", p:"y√¨si", m:"meaning", e:"üìñ"}, {c:"Âõ†‰∏∫", p:"yƒ´nw√®i", m:"because", e:"üí°"}, {c:"ÊâÄ‰ª•", p:"su«íy«ê", m:"so", e:"üèÅ"}, {c:"Èò¥", p:"yƒ´n", m:"cloudy", e:"‚òÅÔ∏è"},
    {c:"Ê∏∏Ê≥≥", p:"y√≥uy«íng", m:"to swim", e:"üèä"}, {c:"Âè≥Ëæπ", p:"y√≤ubian", m:"right side", e:"üëâ"}, {c:"È±º", p:"y√∫", m:"fish", e:"üêü"}, {c:"Ëøú", p:"yu«én", m:"far", e:"üî≠"}, {c:"ËøêÂä®", p:"y√πnd√≤ng", m:"exercise", e:"üèÉ"},
    {c:"ÂÜç", p:"z√†i", m:"again", e:"üîÅ"}, {c:"Êó©‰∏ä", p:"z«éoshang", m:"morning", e:"üåÖ"}, {c:"‰∏àÂ§´", p:"zh√†ngfu", m:"husband", e:"ü§µ"}, {c:"Êâæ", p:"zh«éo", m:"to look for", e:"üîç"}, {c:"ÁùÄ", p:"zhe", m:"(aspect particle)", e:"üîÑ"},
    {c:"Áúü", p:"zhƒìn", m:"really / truly", e:"üò≤"}, {c:"Ê≠£Âú®", p:"zh√®ngz√†i", m:"in process of", e:"‚è≥"}, {c:"Áü•ÈÅì", p:"zhƒ´dao", m:"to know", e:"üß†"}, {c:"ÂáÜÂ§á", p:"zh«înb√®i", m:"to prepare", e:"üìù"}, {c:"Ëá™Ë°åËΩ¶", p:"z√¨x√≠ngchƒì", m:"bicycle", e:"üö≤"},
    {c:"Ëµ∞", p:"z«íu", m:"to walk", e:"üö∂"}, {c:"ÊúÄ", p:"zu√¨", m:"most / -est", e:"üîù"}, {c:"Â∑¶Ëæπ", p:"zu«íbian", m:"left side", e:"üëà"}
];

let curIdx = 0, writers = [], ansShow = false, wrongAnswers = [];
let matchPool = [], matchedCount = 0, selectedMatch = [];

function cleanup() {
    writers.forEach(w => { if(w && w.destroy) w.destroy(); });
    writers = [];
    document.getElementById('s-grids').innerHTML = '';
    document.getElementById('w-grids').innerHTML = '';
}

function switchMode(m, idx = 0) {
    cleanup();
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    if(document.getElementById('n-'+m)) document.getElementById('n-'+m).classList.add('active');
    document.querySelectorAll('.view, #result-screen').forEach(v => v.style.display = 'none');
    
    const target = document.getElementById('mode-'+m);
    if(target) target.style.display = (['list', 'match', 'wrong'].includes(m)) ? 'block' : 'flex';
    
    curIdx = idx;
    requestAnimationFrame(() => {
        if(m==='list') renderList();
        else if(m==='match') resetMatchGame();
        else if(m==='wrong') renderWrong();
        else updateUI();
    });
}

function updateUI() {
    const item = vocabulary[curIdx];
    document.getElementById('feedback-box').innerText = '';
    const isLearn = document.getElementById('mode-learn').style.display !== 'none';
    const isWrite = document.getElementById('mode-write').style.display !== 'none';

    if(isLearn) {
        document.getElementById('s-pinyin').innerText = item.p;
        document.getElementById('s-mean').innerText = item.m;
        [...item.c].forEach((char, i) => {
            const wrap = createGrid(char, 'study', i);
            document.getElementById('s-grids').appendChild(wrap);
            const w = HanziWriter.create(wrap.querySelector('.writer-div'), char, { width:160, height:160, padding:5, strokeColor:'#2f3542' });
            writers.push(w);
            wrap.onclick = () => { speak(char); w.animateCharacter(); };
        });
    }

    if(isWrite) {
        document.getElementById('w-mean').innerText = item.m;
        ansShow = false; document.getElementById('ans-btn').innerText = "Show Answer";
        [...item.c].forEach((char, i) => {
            const wrap = createGrid(char, 'write', i);
            document.getElementById('w-grids').appendChild(wrap);
            initCanvas(wrap.querySelector('canvas'));
        });
    }
    document.getElementById('p-char').innerText = item.c;
    document.getElementById('p-input').value = '';
}

function createGrid(char, mode, idx) {
    const w = document.createElement('div'); w.className = 'tian-wrapper';
    w.innerHTML = `<div class="tianzige"></div><div class="writer-div"></div>`;
    if(mode === 'write') w.innerHTML += `<canvas width="160" height="160"></canvas>`;
    return w;
}

function initCanvas(can) {
    const ctx = can.getContext('2d');
    let drawing = false; ctx.strokeStyle = "red"; ctx.lineWidth = 8; ctx.lineCap = "round";
    const getP = (e) => { 
        const r = can.getBoundingClientRect(); 
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    };
    const start = (e) => { e.preventDefault(); drawing = true; const p = getP(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    const move = (e) => { if(!drawing) return; const p = getP(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
    const end = () => { drawing = false; };
    can.addEventListener('touchstart', start); can.addEventListener('touchmove', move); can.addEventListener('touchend', end);
    can.addEventListener('mousedown', start); can.addEventListener('mousemove', move); can.addEventListener('mouseup', end);
}

function handleAnswer() {
    ansShow = !ansShow;
    const item = vocabulary[curIdx];
    document.getElementById('ans-btn').innerText = ansShow ? "Hide Answer" : "Show Answer";
    const grids = document.querySelectorAll('#w-grids .writer-div');
    grids.forEach((g, i) => {
        g.innerHTML = '';
        if(ansShow) HanziWriter.create(g, item.c[i], { width: 160, height: 160, padding: 5, strokeColor: '#ccc' });
    });
}

function resetMatchGame() {
    matchPool = [...vocabulary].sort(() => 0.5 - Math.random());
    matchedCount = 0;
    initMatchRound();
}

function initMatchRound() {
    const g = document.getElementById('match-grid'); g.innerHTML = ''; selectedMatch = [];
    document.getElementById('match-progress').innerText = `Progress: ${matchedCount}/150`;
    const roundItems = matchPool.slice(0, 4);
    if(!roundItems.length) { showFinal(); return; }
    let items = [];
    roundItems.forEach(v => {
        items.push({t: v.c, id: v.c}, {t: v.p, id: v.c}, {t: v.m, id: v.c});
    });
    items.sort(() => 0.5 - Math.random()).forEach(it => {
        const d = document.createElement('div'); d.className = 'match-item'; d.innerText = it.t;
        d.onclick = () => {
            if(d.classList.contains('selected') || d.classList.contains('hidden')) return;
            d.classList.add('selected'); selectedMatch.push({el: d, id: it.id});
            if(selectedMatch.length === 3) {
                if(selectedMatch[0].id === selectedMatch[1].id && selectedMatch[1].id === selectedMatch[2].id) {
                    speak(selectedMatch[0].id);
                    selectedMatch.forEach(s => s.el.classList.add('hidden'));
                    if(!document.querySelector('.match-item:not(.hidden)')) {
                        matchedCount += roundItems.length;
                        matchPool.splice(0, 4);
                        setTimeout(initMatchRound, 500);
                    }
                } else { setTimeout(() => { selectedMatch.forEach(s => s.el.classList.remove('selected')); selectedMatch = []; }, 500); return; }
                selectedMatch = [];
            }
        };
        g.appendChild(d);
    });
}

function checkPinyin() {
    const input = document.getElementById('p-input').value.toLowerCase().trim();
    const correct = vocabulary[curIdx].p.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "");
    const cleanInput = input.replace(/\s+/g, "");
    if(cleanInput === correct) {
        document.getElementById('feedback-box').innerText='üëç Good!';
        setTimeout(() => { if(curIdx >= 149) showFinal(); else nextWord(); }, 800);
    } else {
        document.getElementById('feedback-box').innerText='‚ùå Wrong';
        if(!wrongAnswers.includes(vocabulary[curIdx])) wrongAnswers.push(vocabulary[curIdx]);
    }
}

function nextWord() { curIdx = (curIdx + 1) % 150; cleanup(); updateUI(); }

function showFinal() {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById('result-screen').style.display = 'block';
    const praises = ["Â§™Ê£í‰∫ÜÔºÅ", "‰Ω†ÁúüÂéâÂÆ≥ÔºÅ", "ÈùûÂ∏∏Âá∫Ëâ≤ÔºÅ", "HSK2 ËææÊ†áÔºÅ"];
    const text = praises[Math.floor(Math.random()*praises.length)];
    document.getElementById('result-text').innerText = text;
    speak(text);
}

function renderList() {
    document.getElementById('list-view').innerHTML = vocabulary.map((v, i) => `
        <div class="list-card" onclick="switchMode('learn', ${i})">
            <b style="font-size:1.5rem;">${v.c}</b>
            <div><span style="color:var(--pinyin-red); font-weight:bold; font-size:1.1rem;">${v.p}</span><br><small>${v.m}</small></div>
            <span style="margin-left:auto;">${v.e}</span>
        </div>`).join('');
}

function renderWrong() {
    const container = document.getElementById('wrong-view');
    if(!wrongAnswers.length) { container.innerHTML = "<p style='text-align:center; padding:20px;'>No mistakes yet! Keep practicing!</p>"; return; }
    container.innerHTML = wrongAnswers.map(v => {
        const idx = vocabulary.findIndex(it => it.c === v.c);
        return `<div class="list-card" onclick="switchMode('learn', ${idx})"><b>${v.c}</b><div><span style="color:var(--pinyin-red); font-weight:bold;">${v.p}</span><br><small>${v.m}</small></div></div>`;
    }).join('');
}

function speak(t) { 
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t); 
        m.lang = 'zh-CN'; m.rate = 0.8; 
        window.speechSynthesis.speak(m); 
    }
}

function enterApp() { 
    document.getElementById('cover-page').style.opacity = '0'; 
    setTimeout(() => { 
        document.getElementById('cover-page').style.display = 'none'; 
        switchMode('learn'); 
    }, 500); 
}

window.onload = () => {
    const container = document.getElementById('star-container');
    for(let i=0; i<50; i++) {
        let s = document.createElement('div'); s.className = 'star';
        s.style.setProperty('--angle', Math.random() * 360 + 'deg');
        s.style.animationDuration = Math.random() * 1 + 1 + 's';
        container.appendChild(s);
    }
};
</script>
</body>
</html>